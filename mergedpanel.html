<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Admin & Agent Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="database.js"></script>
  <script src="khata-book.js"></script>
  <script src="deposit-withdraw.js"></script>
  <script src="submit-data.js"></script>
  <script src="user-management.js"></script>
  <script src="number-system.js"></script>
  <script src="balance-khata-manager.js"></script>
  <script src="panel-balance-fix.js"></script>
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2ecc71;
      --secondary-dark: #27ae60;
      --danger: #e74c3c;
      --danger-dark: #c0392b;
      --warning: #f39c12;
      --warning-dark: #e67e22;
      --dark: #1e1e1e;
      --darker: #111111;
      --light: #f5f5f5;
      --gray: #aaaaaa;
      --success: #2ecc71;
      --admin: #9b59b6;
      --super-master: #e74c3c;
      --master: #3498db;
      --agent: #2ecc71;
      --super-agent: #1abc9c;
      --client: #95a5a6;
      
      /* Client Panel Colors */
      --client-primary: #6c5ce7;
      --client-primary-dark: #5649c0;
      --client-secondary: #00cec9;
      --client-accent: #fd79a8;
      --client-dark: #2d3436;
      --client-darker: #1e272e;
      --client-light: #f5f6fa;
      --client-success: #00b894;
      --client-danger: #d63031;
      --client-warning: #fdcb6e;
      --client-info: #0984e3;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: var(--darker);
      color: var(--light);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
      background-image: radial-gradient(circle at 10% 20%, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.8) 90%);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
    }
    
    .menu-icon {
      font-size: 24px;
      cursor: pointer;
      color: var(--primary);
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: none;
    }
    
    .menu-icon:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .dropdown-menu {
      position: absolute;
      top: 50px;
      left: 0;
      background: rgba(30,30,30,0.95);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: none;
      z-index: 100;
      min-width: 200px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .dropdown-menu.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .dropdown-item {
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dropdown-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    h1, h2, h3 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    h1 {
      font-size: 2.5rem;
      position: relative;
      display: inline-block;
      padding-bottom: 10px;
      animation: fadeInDown 0.8s ease;
    }
    
    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }
    
    .tab {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .tab button {
      padding: 12px 25px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: var(--light);
      cursor: pointer;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    .tab button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }
    
    .tab button:hover::before {
      left: 100%;
    }
    
    .tab button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .tab button.active {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(52,152,219,0.4);
    }
    
    .panel {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .panel.active {
      display: block;
    }
    
    .section {
      background: rgba(30,30,30,0.8);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.4);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: var(--light);
      font-size: 16px;
      transition: all 0.3s ease;
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 3px rgba(52,152,219,0.3);
      border-color: var(--primary);
    }
    
    .panel-selector {
      position: relative;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .panel-dropdown {
      width: 100%;
      padding: 12px 15px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: var(--light);
      font-size: 16px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.1);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23aaaaaa' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
    }
    
    button {
      display: inline-block;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-decoration: none;
      font-size: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-top: 10px;
      position: relative;
      overflow: hidden;
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255,255,255,0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    button:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: 0 6px 12px rgba(52,152,219,0.4);
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background: var(--secondary-dark);
      box-shadow: 0 6px 12px rgba(46,204,113,0.4);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: var(--danger-dark);
      box-shadow: 0 6px 12px rgba(231,76,60,0.4);
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: var(--warning-dark);
      box-shadow: 0 6px 12px rgba(243,156,18,0.4);
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-sm {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-group .btn {
      flex: 1;
    }
    
    .inline {
      display: flex;
      gap: 10px;
    }
    
    .inline input {
      flex: 1;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    
    .success {
      background: rgba(46,204,113,0.2);
      color: var(--success);
      border-left: 4px solid var(--success);
    }
    
    .error {
      background: rgba(231,76,60,0.2);
      color: var(--danger);
      border-left: 4px solid var(--danger);
    }
    
    .warning {
      background: rgba(243,156,18,0.2);
      color: var(--warning);
      border-left: 4px solid var(--warning);
    }
    
    .info {
      background: rgba(52,152,219,0.2);
      color: var(--primary);
      border-left: 4px solid var(--primary);
    }
    
    .list-container {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--dark);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .list-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .list-container::-webkit-scrollbar-track {
      background: var(--dark);
      border-radius: 10px;
    }
    
    .list-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }
    
    .list-item {
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      border-left: 4px solid var(--primary);
      animation: fadeInUp 0.5s ease;
    }
    
    .list-item:nth-child(odd) {
      background: rgba(255,255,255,0.03);
    }
    
    .list-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .list-item-header {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .list-item-title {
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .list-item-actions {
      display: flex;
      gap: 8px;
    }
    
    .list-item-details {
      width: 100%;
      font-size: 14px;
      color: var(--gray);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .list-item-detail {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-success {
      background: rgba(46,204,113,0.2);
      color: var(--success);
    }
    
    .badge-danger {
      background: rgba(231,76,60,0.2);
      color: var(--danger);
    }
    
    .badge-warning {
      background: rgba(243,156,18,0.2);
      color: var(--warning);
    }
    
    .badge-info {
      background: rgba(52,152,219,0.2);
      color: var(--primary);
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
      animation: fadeIn 0.5s ease;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.08);
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 10px 0;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray);
    }
    
    .commission-box {
      background: rgba(243,156,18,0.1);
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      border-left: 4px solid var(--warning);
      animation: pulse 2s infinite;
    }
    
    .loss-box {
      background: rgba(231,76,60,0.1);
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      border-left: 4px solid var(--danger);
    }
    
    .profit {
      color: var(--success);
    }
    
    .loss {
      color: var(--danger);
    }
    
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-box input {
      padding-left: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23aaaaaa' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 15px center;
      background-size: 16px;
    }
    
    .user-type-indicator {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-weight: bold;
      margin-right: 8px;
      font-size: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .admin-indicator {
      background: var(--admin);
      color: white;
    }
    
    .super-master-indicator {
      background: var(--super-master);
      color: white;
    }
    
    .master-indicator {
      background: var(--master);
      color: white;
    }
    
    .agent-indicator {
      background: var(--agent);
      color: white;
    }
    
    .super-agent-indicator {
      background: var(--super-agent);
      color: white;
    }
    
    .client-indicator {
      background: var(--client);
      color: white;
    }
    
    .hierarchy-path {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .announcement-banner {
      background: rgba(243,156,18,0.2);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid var(--warning);
      animation: pulse 2s infinite;
      text-align: center;
      font-weight: 600;
    }
    
    .total-summary {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    
    .total-box {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
    }
    
    .total-lena {
      border-left: 4px solid var(--success);
    }
    
    .total-dena {
      border-left: 4px solid var(--danger);
    }
    
    .total-label {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .total-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    /* Popup Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: var(--dark);
      border-radius: 15px;
      padding: 25px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 15px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
      animation: modalFadeIn 0.3s ease;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .modal-title {
      font-size: 1.5rem;
      color: var(--primary);
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--gray);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.1);
      color: var(--light);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .btn-group {
        flex-direction: column;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .list-item-actions {
        flex-direction: column;
        width: 100%;
      }
      
      .list-item-actions .btn {
        width: 100%;
      }
      
      .tab {
        flex-direction: column;
      }
      
      .section {
        padding: 15px;
      }
      
      .inline {
        flex-direction: column;
      }
      
      .total-summary {
        flex-direction: column;
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }
    
    /* Client Panel Styles */
    .client-body {
      background: linear-gradient(135deg, var(--client-darker), var(--client-dark));
      color: var(--client-light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
      margin: 0;
      line-height: 1.6;
    }
    
    .client-h1, .client-h2 {
      text-align: center;
      color: var(--client-primary);
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .client-h1 {
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(to right, var(--client-primary), var(--client-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .client-section {
      background: rgba(30, 39, 46, 0.8);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }
    
    .client-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }
    
    .client-input, .client-button, .client-select {
      width: 100%;
      padding: 12px 15px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .client-input, .client-select {
      background: rgba(45, 52, 54, 0.7);
      color: var(--client-light);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .client-input:focus, .client-select:focus {
      outline: none;
      border-color: var(--client-primary);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.3);
    }
    
    .client-button {
      background: var(--client-primary);
      color: var(--client-light);
      cursor: pointer;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.9rem;
    }
    
    .client-button:hover {
      background: var(--client-primary-dark);
      transform: translateY(-2px);
    }
    
    .client-button:active {
      transform: translateY(0);
    }
    
    .client-button:disabled {
      background: #636e72;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .list-box {
      background: rgba(45, 52, 54, 0.5);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--client-primary) var(--client-darker);
    }
    
    .list-box::-webkit-scrollbar {
      width: 8px;
    }
    
    .list-box::-webkit-scrollbar-track {
      background: var(--client-darker);
      border-radius: 10px;
    }
    
    .list-box::-webkit-scrollbar-thumb {
      background: var(--client-primary);
      border-radius: 10px;
    }
    
    .client-logout {
      background: var(--client-danger);
    }
    
    .client-logout:hover {
      background: #c0392b;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .cell {
      background: var(--client-primary);
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .cell:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .cell.opened {
      background: var(--client-success);
      color: #000;
      transform: rotateY(180deg);
    }
    
    .cell.bomb {
      background: var(--client-danger);
      color: white;
      animation: shake 0.5s;
    }
    
    .btn-blue { background: var(--client-info); }
    .btn-orange { background: #e17055; }
    .btn-purple { background: var(--client-primary); }
    .btn-pink { background: var(--client-accent); }
    .btn-teal { background: var(--client-secondary); }
    
    .inline {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .inline .client-button {
      width: auto;
      flex: 1;
    }
    
    #plane {
      font-size: 3rem;
      text-align: center;
      margin: 30px 0;
      transition: all 0.1s ease;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
    }
    
    #multiplier {
      font-size: 1.8rem;
      text-align: center;
      margin: 20px 0;
      font-weight: bold;
      color: var(--client-warning);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    #history {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
    
    .history-multiplier {
      padding: 6px 12px;
      border-radius: 20px;
      background: var(--client-darker);
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .history-multiplier:hover {
      transform: scale(1.1);
    }
    
    .stats-box {
      display: flex;
      justify-content: space-around;
      margin: 25px 0;
      background: rgba(45, 52, 54, 0.5);
      padding: 15px;
      border-radius: 10px;
    }
    
    .stats-item {
      text-align: center;
      padding: 0 15px;
    }
    
    .stats-item:not(:last-child) {
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    
    .small-text {
      font-size: 0.8rem;
      color: #b2bec3;
      margin-bottom: 5px;
    }
    
    .game-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .game-controls .client-button {
      flex: 1;
    }
    
    /* Lucky 7 Game Styles */
    .lucky7-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }
    
    .lucky7-slot {
      width: 80px;
      height: 100px;
      background: rgba(45, 52, 54, 0.7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      color: #fff;
      border: 2px solid var(--client-primary);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .lucky7-slot.spinning {
      animation: pulse 0.5s infinite alternate;
    }
    
    .lucky7-btn {
      margin: 20px auto;
      display: block;
      width: 200px;
      padding: 15px;
      font-size: 1.1rem;
      border-radius: 50px;
      background: var(--client-accent);
      box-shadow: 0 5px 15px rgba(253, 121, 168, 0.4);
    }
    
    .lucky7-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(253, 121, 168, 0.6);
    }
    
    .lucky7-payouts {
      margin: 25px 0;
      padding: 20px;
      background: rgba(45, 52, 54, 0.5);
      border-radius: 10px;
      border-left: 4px solid var(--client-primary);
    }
    
    .lucky7-payouts h3 {
      margin-top: 0;
      color: var(--client-primary);
      margin-bottom: 15px;
    }
    
    .lucky7-payouts ul {
      padding-left: 20px;
      margin-bottom: 0;
      list-style-type: none;
    }
    
    .lucky7-payouts li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 25px;
    }
    
    .lucky7-payouts li:before {
      content: "→";
      position: absolute;
      left: 0;
      color: var(--client-primary);
    }
    
    /* Dragon Tiger Styles */
    .cards {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 30px 0;
    }
    
    #dragonCard, #tigerCard {
      width: 120px;
      height: 180px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: black;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      transition: all 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    
    #dragonCard:before, #tigerCard:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
      z-index: 1;
    }
    
    #dragonCard.red, #tigerCard.red {
      color: var(--client-danger);
    }
    
    #dragonCard.black, #tigerCard.black {
      color: var(--client-dark);
    }
    
    /* Loading spinner */
    .spinner {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--client-primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Notification toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: var(--client-success);
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateX(200%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: var(--client-danger);
    }
    
    /* Floating coins animation */
    .coin-animation {
      position: absolute;
      font-size: 1.5rem;
      animation: floatCoin 2s ease-out forwards;
      opacity: 0;
    }
    
    @keyframes floatCoin {
      0% { transform: translateY(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100px); opacity: 0; }
    }
    
    /* Number System Styles */
    .number-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .number-box {
      width: calc(25% - 10px);
      min-width: 80px;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .number-box:hover {
      background: rgba(52,152,219,0.3);
      transform: scale(1.05);
    }
    
    .number-box.has-bet {
      background: rgba(46,204,113,0.3);
      border-color: var(--success);
    }
    
    .number-box .number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--light);
    }
    
    .number-box .bet-info {
      font-size: 0.8rem;
      color: var(--warning);
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>

  <div class="header">
    <div class="menu-icon" id="adminMenuIcon" onclick="toggleMenu()">
      <i class="fas fa-ellipsis-v"></i>
    </div>
    <h1 class="animate__animated animate__fadeInDown">Advanced Admin & Agent Panel</h1>
    <div></div> <!-- Empty div for flex alignment -->
  </div>
  
  <div class="dropdown-menu" id="adminMenu">
    <div class="dropdown-item" onclick="showSection('dashboard')">
      <i class="fas fa-tachometer-alt"></i> Dashboard
    </div>
    <div class="dropdown-item" onclick="showSection('ledger')">
      <i class="fas fa-book"></i> Ledger
    </div>
    <div class="dropdown-item" onclick="showSection('deadUsers')">
      <i class="fas fa-user-slash"></i> Dead Users
    </div>
    <div class="dropdown-item" onclick="showSection('games')">
      <i class="fas fa-gamepad"></i> Games
    </div>
    <div class="dropdown-item" onclick="showSection('submit')">
      <i class="fas fa-check-circle"></i> Submit
    </div>
    <div class="dropdown-item" onclick="showSection('data')">
      <i class="fas fa-database"></i> Data
    </div>
    <div class="dropdown-item" onclick="showSection('users')">
      <i class="fas fa-users"></i> Users
    </div>
    <div class="dropdown-item" onclick="showSection('createUser')">
      <i class="fas fa-user-plus"></i> Create User
    </div>
    <div class="dropdown-item" onclick="showSection('commission')">
      <i class="fas fa-percentage"></i> Commission
    </div>
    <div class="dropdown-item" onclick="showSection('depositWithdraw')">
      <i class="fas fa-money-bill-wave"></i> Deposit/Withdraw
    </div>
    <div class="dropdown-item" onclick="showSection('khataBook')">
      <i class="fas fa-book-open"></i> Khata Book
    </div>
    <div class="dropdown-item" onclick="showSection('heading')">
      <i class="fas fa-heading"></i> Heading
    </div>
    <div class="dropdown-item" onclick="showSection('numberSystem')">
      <i class="fas fa-dice"></i> Number System
    </div>
  </div>
  
  <!-- Single Login Panel -->
  <div id="login" class="panel active">
    <div class="section animate__animated animate__fadeIn">
      <h3><i class="fas fa-sign-in-alt"></i> Login</h3>
      <div class="panel-selector">
        <select class="panel-dropdown" id="loginPanel">
          <option value="">Select Panel</option>
          <option value="admin">Admin</option>
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
          <option value="client">Client</option>
        </select>
      </div>
      <input type="text" id="loginName" placeholder="Login Name">
      <input type="password" id="loginPassword" placeholder="Password">
      <button class="btn btn-primary btn-block" onclick="login()">Login</button>
      <div id="loginMsg" class="message" style="display: none;"></div>
    </div>
  </div>
  
  <!-- Announcement Banner -->
  <div id="announcementBanner" class="announcement-banner" style="display: none;"></div>
  
  <!-- Admin Panel -->
  <div id="admin" class="panel">
    <div id="adminPanel" style="display: none;">
      <!-- Dashboard Section -->
      <div class="section animate__animated animate__fadeIn" id="dashboardSection">
        <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
        <div class="stats-container">
          <div class="stat-card" onclick="showUserList('superMasters')">
            <div class="stat-label">Total Super Masters</div>
            <div class="stat-value" id="totalSuperMasters">0</div>
          </div>
          <div class="stat-card" onclick="showUserList('masters')">
            <div class="stat-label">Total Masters</div>
            <div class="stat-value" id="totalMasters">0</div>
          </div>
          <div class="stat-card" onclick="showUserList('agents')">
            <div class="stat-label">Total Agents</div>
            <div class="stat-value" id="totalAgents">0</div>
          </div>
          <div class="stat-card" onclick="showUserList('clients')">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value" id="totalClients">0</div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="refreshDashboard()">Refresh</button>
        </div>
      </div>
      
      <!-- Ledger Section -->
      <div class="section animate__animated animate__fadeIn" id="ledgerSection" style="display: none;">
        <h3><i class="fas fa-book"></i> Ledger</h3>
        <input type="date" id="ledgerDate">
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="renderLedger()">Show Ledger</button>
          <button class="btn btn-danger" onclick="deleteSelectedLedger()">Delete Selected</button>
        </div>
        
        <!-- Total Lena/Dena Summary -->
        <div class="total-summary">
          <div class="total-box total-lena" onclick="showLenaUsers()">
            <div class="total-label">Total Lena (Deposit)</div>
            <div class="total-value profit" id="totalLena">₹0</div>
          </div>
          <div class="total-box total-dena" onclick="showDenaUsers()">
            <div class="total-label">Total Dena (Withdraw)</div>
            <div class="total-value loss" id="totalDena">₹0</div>
          </div>
        </div>
        
        <div class="list-container" id="ledgerList"></div>
      </div>
      
      <!-- Dead Users Section -->
      <div class="section animate__animated animate__fadeIn" id="deadUsersSection" style="display: none;">
        <h3><i class="fas fa-user-slash"></i> Dead Users</h3>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="renderDeadUsers()">Refresh</button>
        </div>
        <div class="list-container" id="deadUsersList"></div>
      </div>
      
      <!-- Games Section -->
      <div class="section animate__animated animate__fadeIn" id="gamesSection" style="display: none;">
        <h3><i class="fas fa-gamepad"></i> Games</h3>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="renderGames()">Refresh</button>
        </div>
        <div class="list-container" id="gamesListContainer"></div>
      </div>
      
      <!-- Submit Section -->
      <div class="section animate__animated animate__fadeIn" id="submitSection" style="display: none;">
        <h3><i class="fas fa-check-circle"></i> Submit</h3>
        <select id="submitPanel">
          <option value="">Select Panel</option>
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
        </select>
        <select id="submitUser">
          <option value="">Select User</option>
        </select>
        <input type="number" id="submitAmount" placeholder="Amount">
        <input type="date" id="submitDate">
        <div class="inline">
          <select id="submitType">
            <option value="deposit">Lena</option>
            <option value="withdraw">Dena</option>
          </select>
        </div>
        <button class="btn btn-primary btn-block" onclick="SubmitDataManager.submitTransaction()">Save</button>
        <div id="submitMsg" class="message" style="display: none;"></div>
      </div>
      
      <!-- Data Section -->
      <div class="section animate__animated animate__fadeIn" id="dataSection" style="display: none;">
        <h3><i class="fas fa-database"></i> Submitted Data</h3>
        <input type="date" id="dataDate">
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="renderSubmittedData()">Show Data</button>
          <button class="btn btn-danger" onclick="deleteSelectedData()">Delete Selected</button>
        </div>
        <div class="list-container" id="submittedDataList"></div>
      </div>
      
      <!-- Users Section -->
      <div class="section animate__animated animate__fadeIn" id="usersSection" style="display: none;">
        <h3><i class="fas fa-users"></i> All Users</h3>
        <select id="usersPanel">
          <option value="">Select Panel</option>
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
          <option value="client">Client</option>
        </select>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="UserManagement.renderAllUsers()">Show Users</button>
        </div>
        <div class="list-container" id="allUsersList"></div>
      </div>
      
      <!-- Create User Section -->
      <div class="section animate__animated animate__fadeIn" id="createUserSection" style="display: none;">
        <h3><i class="fas fa-user-plus"></i> Create User</h3>
        <select id="userType">
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
        </select>
        <input type="text" id="newUser" placeholder="Username">
        <input type="text" id="newLoginName" placeholder="Login Name">
        <input type="password" id="newPass" placeholder="Password">
        <div class="inline">
          <input type="number" id="winCommission" placeholder="Win Commission %">
          <input type="number" id="lossCommission" placeholder="Loss Commission %">
        </div>
        <button class="btn btn-primary btn-block" onclick="createUser()">Create User</button>
        <div id="userMsg" class="message" style="display: none;"></div>
      </div>
      
      <!-- Commission Section -->
      <div class="section animate__animated animate__fadeIn" id="commissionSection" style="display: none;">
        <h3><i class="fas fa-percentage"></i> Commission Management</h3>
        <select id="commissionPanel">
          <option value="">Select Panel</option>
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
        </select>
        <select id="selectUserForCommission">
          <option value="">Select User</option>
        </select>
        <div class="inline">
          <input type="number" id="newWinCommission" placeholder="New Win Commission %">
          <input type="number" id="newLossCommission" placeholder="New Loss Commission %">
        </div>
        <button class="btn btn-primary btn-block" onclick="updateUserCommission()">Update Commission</button>
        <div id="userCommissionInfo" class="commission-box"></div>
      </div>
      
      <!-- Deposit/Withdraw Section -->
      <div class="section animate__animated animate__fadeIn" id="depositWithdrawSection" style="display: none;">
        <h3><i class="fas fa-money-bill-wave"></i> Deposit / Withdraw</h3>
        <select id="transactionPanel">
          <option value="">Select Panel</option>
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
        </select>
        <input type="text" id="transUser" placeholder="Username">
        <input type="number" id="transAmt" placeholder="Amount">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="TransactionManager.deposit()">Deposit</button>
          <button class="btn btn-danger" onclick="TransactionManager.withdraw()">Withdraw</button>
        </div>
        <div id="transMsg" class="message" style="display: none;"></div>
      </div>
      
      <!-- Khata Book Section -->
      <div class="section animate__animated animate__fadeIn" id="khataBookSection" style="display: none;">
        <h3><i class="fas fa-book-open"></i> Khata Book</h3>
        <select id="khataPanel">
          <option value="">Select Panel</option>
          <option value="superMaster">Super Master</option>
          <option value="master">Master</option>
          <option value="agent">Agent</option>
        </select>
        <select id="khataUser">
          <option value="">Select User</option>
        </select>
        <textarea id="khataNote" placeholder="Type your note here..." rows="4"></textarea>
        <button class="btn btn-primary btn-block" onclick="KhataBookManager.addKhataNote()">Add Note</button>
        <div id="khataMsg" class="message" style="display: none;"></div>
        
        <div class="list-container" id="khataList"></div>
      </div>
      
      <!-- Heading Section -->
      <div class="section animate__animated animate__fadeIn" id="headingSection" style="display: none;">
        <h3><i class="fas fa-heading"></i> Announcement / Heading</h3>
        <textarea id="announcementText" placeholder="Type your announcement here..." rows="4"></textarea>
        <button class="btn btn-primary btn-block" onclick="updateAnnouncement()">Update Announcement</button>
        <div id="headingMsg" class="message" style="display: none;"></div>
      </div>
      
      <!-- Number System Section -->
      <div class="section animate__animated animate__fadeIn" id="numberSystemSection" style="display: none;">
        <h3><i class="fas fa-dice"></i> Number System</h3>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="NumberSystem.loadBets('ghaziabad')">Ghaziabad</button>
          <button class="btn btn-primary" onclick="NumberSystem.loadBets('faridabad')">Faridabad</button>
          <button class="btn btn-primary" onclick="NumberSystem.loadBets('gali')">Gali</button>
          <button class="btn btn-primary" onclick="NumberSystem.loadBets('disawar')">Disawar</button>
          <button class="btn btn-warning" onclick="NumberSystem.loadBets('harup')">Harup</button>
        </div>
        
        <div id="numberGridContainer" style="margin-top: 20px;"></div>
      </div>
      
      <button class="btn btn-danger btn-block" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>
  
  <!-- Super Master Panel -->
  <div id="superMaster" class="panel">
    <div id="superMasterPanel" style="display: none;">
      <div class="section animate__animated animate__fadeIn">
        <h3><span class="user-type-indicator super-master-indicator">SM</span> Super Master Panel</h3>
        <div class="hierarchy-path">
          <span class="user-type-indicator admin-indicator">A</span> Admin > 
          <span class="user-type-indicator super-master-indicator">SM</span> Super Master
        </div>
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-label">Total Masters</div>
            <div class="stat-value" id="smTotalMasters">0</div>
            <div class="stat-label">Under this SM</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Agents</div>
            <div class="stat-value" id="smTotalAgents">0</div>
            <div class="stat-label">Under this SM</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value" id="smTotalClients">0</div>
            <div class="stat-label">Under this SM</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value profit" id="smTotalBalance">₹0</div>
            <div class="stat-label">Current Status</div>
          </div>
        </div>
        <div class="commission-box">
          <h4><i class="fas fa-percentage"></i> Commission Information</h4>
          <p>Win Commission: <strong id="smWinCommission">15%</strong> | Loss Commission: <strong id="smLossCommission">15%</strong></p>
          <p>Total Commission Earned: <strong class="profit" id="smTotalCommission">₹0</strong></p>
        </div>
        <div class="btn-group">
          <button class="btn btn-info" onclick="viewKhataBook()"><i class="fas fa-book-open"></i> View Khata Book</button>
        </div>
      </div>
      
      <div class="section animate__animated animate__fadeIn">
        <h3><i class="fas fa-users"></i> Manage Masters</h3>
        <div class="search-box">
          <input type="text" id="searchMaster" placeholder="Search Masters...">
        </div>
        <div class="list-container" id="mastersList"></div>
      </div>
      
      <div class="section animate__animated animate__fadeIn">
        <h3><i class="fas fa-user-plus"></i> Create Master</h3>
        <input type="text" id="newMaster" placeholder="Master Username">
        <input type="text" id="newMasterLoginName" placeholder="Master Login Name">
        <input type="password" id="newMasterPass" placeholder="Master Password">
        <div class="inline">
          <input type="number" id="masterWinCommission" placeholder="Win Commission %">
          <input type="number" id="masterLossCommission" placeholder="Loss Commission %">
        </div>
        <button class="btn btn-primary btn-block" onclick="createMaster()">Create Master</button>
        <div id="masterMsg" class="message" style="display: none;"></div>
      </div>
      
      <button class="btn btn-danger btn-block" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>
  
  <!-- Master Panel -->
  <div id="master" class="panel">
    <div id="masterPanel" style="display: none;">
      <div class="section animate__animated animate__fadeIn">
        <h3><span class="user-type-indicator master-indicator">M</span> Master Panel</h3>
        <div class="hierarchy-path">
          <span class="user-type-indicator admin-indicator">A</span> Admin > 
          <span class="user-type-indicator super-master-indicator">SM</span> Super Master > 
          <span class="user-type-indicator master-indicator">M</span> Master
        </div>
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-label">Total Agents</div>
            <div class="stat-value" id="mTotalAgents">0</div>
            <div class="stat-label">Under this Master</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value" id="mTotalClients">0</div>
            <div class="stat-label">Under this Master</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value profit" id="mTotalBalance">₹0</div>
            <div class="stat-label">Current Status</div>
          </div>
        </div>
        <div class="commission-box">
          <h4><i class="fas fa-percentage"></i> Commission Information</h4>
          <p>Win Commission: <strong id="mWinCommission">10%</strong> | Loss Commission: <strong id="mLossCommission">10%</strong></p>
          <p>Total Commission Earned: <strong class="profit" id="mTotalCommission">₹0</strong></p>
        </div>
        <div class="btn-group">
          <button class="btn btn-info" onclick="viewKhataBook()"><i class="fas fa-book-open"></i> View Khata Book</button>
        </div>
      </div>
      
      <div class="section animate__animated animate__fadeIn">
        <h3><i class="fas fa-users"></i> Manage Agents</h3>
        <div class="search-box">
          <input type="text" id="searchAgent" placeholder="Search Agents...">
        </div>
        <div class="list-container" id="agentsList"></div>
      </div>
      
      <div class="section animate__animated animate__fadeIn">
        <h3><i class="fas fa-user-plus"></i> Create Agent</h3>
        <input type="text" id="newAgent" placeholder="Agent Username">
        <input type="text" id="newAgentLoginName" placeholder="Agent Login Name">
        <input type="password" id="newAgentPass" placeholder="Agent Password">
        <div class="inline">
          <input type="number" id="agentWinCommission" placeholder="Win Commission %">
          <input type="number" id="agentLossCommission" placeholder="Loss Commission %">
        </div>
        <button class="btn btn-primary btn-block" onclick="createAgent()">Create Agent</button>
        <div id="agentMsg" class="message" style="display: none;"></div>
      </div>
      
      <button class="btn btn-danger btn-block" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>
  
  <!-- Agent Panel -->
  <div id="agent" class="panel">
    <div id="agentPanel" style="display: none;">
      <div class="section animate__animated animate__fadeIn">
        <h3><span class="user-type-indicator agent-indicator">A</span> Agent Panel</h3>
        <div class="hierarchy-path">
          <span class="user-type-indicator admin-indicator">A</span> Admin > 
          <span class="user-type-indicator super-master-indicator">SM</span> Super Master > 
          <span class="user-type-indicator master-indicator">M</span> Master > 
          <span class="user-type-indicator agent-indicator">A</span> Agent
        </div>
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value" id="aTotalClients">0</div>
            <div class="stat-label">Under this Agent</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Clients</div>
            <div class="stat-value" id="aActiveClients">0</div>
            <div class="stat-label">Currently Playing</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value profit" id="aTotalBalance">₹0</div>
            <div class="stat-label">Current Status</div>
          </div>
        </div>
        <div class="commission-box">
          <h4><i class="fas fa-percentage"></i> Commission Information</h4>
          <p>Win Commission: <strong id="aWinCommission">5%</strong> | Loss Commission: <strong id="aLossCommission">5%</strong></p>
          <p>Total Commission Earned: <strong class="profit" id="aTotalCommission">₹0</strong></p>
        </div>
        <div class="btn-group">
          <button class="btn btn-info" onclick="viewKhataBook()"><i class="fas fa-book-open"></i> View Khata Book</button>
        </div>
      </div>
      
      <div class="section animate__animated animate__fadeIn">
        <h3><i class="fas fa-users"></i> Manage Clients</h3>
        <div class="search-box">
          <input type="text" id="searchClient" placeholder="Search Clients...">
        </div>
        <div class="list-container" id="clientsList"></div>
      </div>
      
      <div class="section animate__animated animate__fadeIn">
        <h3><i class="fas fa-user-plus"></i> Create Client</h3>
        <input type="text" id="newClient" placeholder="Client Username">
        <input type="text" id="newClientLoginName" placeholder="Client Login Name">
        <input type="password" id="newClientPass" placeholder="Client Password">
        <input type="number" id="clientCredit" placeholder="Credit Limit" value="1000">
        <button class="btn btn-primary btn-block" onclick="createClient()">Create Client</button>
        <div id="clientMsg" class="message" style="display: none;"></div>
      </div>
      
      <button class="btn btn-danger btn-block" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <!-- Client Panel -->
  <div id="client" class="panel">
    <div id="clientPanel" style="display: none;">
      <div class="client-section">
        <h2 class="client-h1">Client Panel</h2>
        <div class="stats-box">
          <div class="stats-item">
            <div class="small-text">Balance</div>
            <div>₹<span id="clientCoins">0</span></div>
          </div>
          <div class="stats-item">
            <div class="small-text">Last Login</div>
            <div id="lastLogin"></div>
          </div>
        </div>
        <button class="client-button client-logout" onclick="logout()">Logout</button>
      </div>

      <div class="client-section">
        <h2 class="client-h2">Games Available</h2>
        <div class="list-box" id="clientGames"></div>
      </div>
    </div>

    <!-- Aviator Game -->
    <div id="aviatorGame" style="display:none">
      <div class="client-section">
        <h2 class="client-h2">🛩️ Aviator Game</h2>
        <div id="balance">Coins: ₹0</div>
        <input class="client-input" type="number" id="aviatorBetAmount" placeholder="Enter Bet ₹10–₹5000" min="10" max="5000">
        <select class="client-select" id="autoCashOut">
          <option value="0">Auto Cash Out Off</option>
          <option value="1.5">Auto @ x1.5</option>
          <option value="2">Auto @ x2</option>
          <option value="3">Auto @ x3</option>
          <option value="5">Auto @ x5</option>
        </select>
        <div class="game-controls">
          <button class="client-button" onclick="placeBet()">Place Bet</button>
          <button class="client-button btn-blue" onclick="cashOut()" id="cashBtn" disabled>💸 Cash Out</button>
        </div>
        <div id="plane" class="floating">🛫</div>
        <div id="multiplier">Multiplier: x1.00</div>
        <div id="result"></div>
        <h3>🕒 Recent Rounds:</h3>
        <div id="history"></div>
        <div class="game-controls">
          <button class="client-button" onclick="resetAviatorGame()">🔄 Restart</button>
          <button class="client-button" onclick="goBackToDashboard()">⬅️ Back</button>
        </div>
      </div>
    </div>

    <!-- Mines Game -->
    <div id="minesGame" style="display:none">
      <div class="client-section">
        <h2 class="client-h2">💣 Mines Game</h2>
        <input class="client-input" type="number" id="minesBetAmount" placeholder="Enter Bet Amount">
        <select class="client-select" id="bombCount">
          <option value="3">3 Bombs</option>
          <option value="5">5 Bombs</option>
          <option value="8">8 Bombs</option>
          <option value="10">10 Bombs</option>
        </select>
        <div class="game-controls">
          <button class="client-button" onclick="startMinesGame()">Start Game</button>
          <button class="client-button btn-orange" onclick="cashOutMines()">Cash Out</button>
        </div>
        <div class="grid" id="minesGrid"></div>
        <p id="minesMsg"></p>
        <div class="game-controls">
          <button class="client-button" onclick="resetMinesGame()">🔄 Restart</button>
          <button class="client-button" onclick="goBackToDashboard()">⬅️ Back</button>
        </div>
      </div>
    </div>

    <!-- Dragon Tiger Game -->
    <div id="dragonTigerGame" style="display:none">
      <div class="client-section">
        <h2 class="client-h2">🐉🐅 Dragon Tiger</h2>
        <input class="client-input" type="number" id="dtBetAmount" placeholder="Enter Bet Amount">
        <div class="inline">
          <button class="client-button btn-blue" onclick="placeDtBet('dragon')">Dragon</button>
          <button class="client-button btn-orange" onclick="placeDtBet('tiger')">Tiger</button>
          <button class="client-button btn-purple" onclick="placeDtBet('tie')">Tie (1:8)</button>
        </div>
        <div id="dtResult"></div>
        <div class="cards">
          <div id="dragonCard"></div>
          <div id="tigerCard"></div>
        </div>
        <div class="game-controls">
          <button class="client-button" onclick="resetDragonTigerGame()">🔄 Restart</button>
          <button class="client-button" onclick="goBackToDashboard()">⬅️ Back</button>
        </div>
      </div>
    </div>

    <!-- Lucky 7 Game -->
    <div id="lucky7Game" style="display:none">
      <div class="client-section">
        <h2 class="client-h2">🍀 Lucky 7</h2>
        <input class="client-input" type="number" id="lucky7BetAmount" placeholder="Enter Bet Amount">
        <button class="client-button lucky7-btn" onclick="playLucky7()">Spin</button>

        <div class="lucky7-container" id="lucky7Slots">
          <div class="lucky7-slot">7</div>
          <div class="lucky7-slot">7</div>
          <div class="lucky7-slot">7</div>
        </div>

        <div id="lucky7Result"></div>

        <div class="lucky7-payouts">
          <h3>Payouts:</h3>
          <ul>
            <li>Three 7s: 5x</li>
            <li>Two 7s: 3x</li>
            <li>One 7: 1.5x</li>
            <li>No 7s: Lose bet</li>
          </ul>
        </div>

        <div class="game-controls">
          <button class="client-button" onclick="resetLucky7Game()">🔄 Restart</button>
          <button class="client-button" onclick="goBackToDashboard()">⬅️ Back</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User List Modal -->
  <div id="userListModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="userListModalTitle">User List</h3>
        <button class="modal-close" onclick="closeUserListModal()">&times;</button>
      </div>
      <div class="list-container" id="userListModalContent"></div>
    </div>
  </div>

  <!-- Khata Book Modal -->
  <div id="khataBookModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Khata Book</h3>
        <button class="modal-close" onclick="closeKhataBookModal()">&times;</button>
      </div>
      <div class="list-container" id="khataBookModalContent"></div>
    </div>
  </div>

  <!-- Bet Modal -->
  <div id="betModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Place Bet</h3>
        <button class="modal-close" onclick="NumberSystem.closeBetModal()">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p>Game: <strong id="betModalGameType"></strong></p>
        <p>Number: <strong id="betModalNumber"></strong></p>
        <input type="hidden" id="betModalGameTypeHidden">
        <input type="hidden" id="betModalNumberHidden">
        <input type="number" id="betAmount" placeholder="Enter bet amount" min="1" style="margin-top: 15px;">
        <p style="margin-top: 10px; color: var(--warning);">Potential Win: 80X</p>
        <div class="btn-group" style="margin-top: 20px;">
          <button class="btn btn-primary" onclick="NumberSystem.placeBet()">Place Bet</button>
          <button class="btn btn-secondary" onclick="NumberSystem.closeBetModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Game list from the provided file (Lucky Spin removed)
    const gamesList = ["Mines", "Aviator", "Dragon Tiger", "Lucky 7"];
    let currentUser = null;
    let currentUserType = null;
    let currentUserId = null;
    const ADMIN_USERNAME = "Admin";
    const ADMIN_PASSWORD = "@admin123";

    // Initialize storage
    function initializeStorage() {
      if (!localStorage.getItem('superMasters')) {
        localStorage.setItem('superMasters', JSON.stringify([]));
      }
      if (!localStorage.getItem('masters')) {
        localStorage.setItem('masters', JSON.stringify([]));
      }
      if (!localStorage.getItem('agents')) {
        localStorage.setItem('agents', JSON.stringify([]));
      }
      if (!localStorage.getItem('clients')) {
        localStorage.setItem('clients', JSON.stringify([]));
      }
      if (!localStorage.getItem('balances')) {
        localStorage.setItem('balances', JSON.stringify({}));
      }
      if (!localStorage.getItem('ledger')) {
        localStorage.setItem('ledger', JSON.stringify([]));
      }
      if (!localStorage.getItem('blockedGames')) {
        localStorage.setItem('blockedGames', JSON.stringify([]));
      }
      if (!localStorage.getItem('khataBook')) {
        localStorage.setItem('khataBook', JSON.stringify([]));
      }
      if (!localStorage.getItem('announcement')) {
        localStorage.setItem('announcement', JSON.stringify(""));
      }
      if (!localStorage.getItem('submittedData')) {
        localStorage.setItem('submittedData', JSON.stringify([]));
      }
      if (!localStorage.getItem('gameHistory')) {
        localStorage.setItem('gameHistory', JSON.stringify([]));
      }
    }

    // Helper functions
    function getStore(k, d = {}) {
      try { 
        return JSON.parse(localStorage.getItem(k)) || d;
      } catch { 
        return d;
      }
    }
    
    function setStore(k, v) {
      localStorage.setItem(k, JSON.stringify(v));
    }

    function showMessage(elementId, message, type = 'success') {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `message ${type}`;
      element.style.display = 'block';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    // Toast notification
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = isError ? 'toast error' : 'toast';
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Toggle the admin menu
    function toggleMenu() {
      const menu = document.getElementById('adminMenu');
      menu.classList.toggle('active');
    }

    // Show specific section from admin menu
    function showSection(sectionName) {
      // Close the menu
      document.getElementById('adminMenu').classList.remove('active');
      
      // Hide all sections
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('ledgerSection').style.display = 'none';
      document.getElementById('deadUsersSection').style.display = 'none';
      document.getElementById('gamesSection').style.display = 'none';
      document.getElementById('submitSection').style.display = 'none';
      document.getElementById('dataSection').style.display = 'none';
      document.getElementById('usersSection').style.display = 'none';
      document.getElementById('createUserSection').style.display = 'none';
      document.getElementById('commissionSection').style.display = 'none';
      document.getElementById('depositWithdrawSection').style.display = 'none';
      document.getElementById('khataBookSection').style.display = 'none';
      document.getElementById('headingSection').style.display = 'none';
      document.getElementById('numberSystemSection').style.display = 'none';
      
      // Show selected section
      document.getElementById(sectionName + 'Section').style.display = 'block';
      
      // Initialize section data if needed
      if (sectionName === 'ledger') {
        document.getElementById('ledgerDate').valueAsDate = new Date();
        renderLedger();
      } else if (sectionName === 'submit') {
        SubmitDataManager.populateSubmitUsers();
        document.getElementById('submitDate').valueAsDate = new Date();
      } else if (sectionName === 'commission') {
        populateCommissionUsers();
      } else if (sectionName === 'data') {
        document.getElementById('dataDate').valueAsDate = new Date();
        SubmitDataManager.renderSubmittedData();
      } else if (sectionName === 'users') {
        UserManagement.renderAllUsers();
      } else if (sectionName === 'khataBook') {
        KhataBookManager.populateKhataUsers();
        KhataBookManager.renderKhataBook();
      } else if (sectionName === 'heading') {
        document.getElementById('announcementText').value = getStore('announcement', '');
      } else if (sectionName === 'numberSystem') {
        // Number system section loaded
      }
    }

    // Login function for all panels
    async function login() {
      const panel = document.getElementById('loginPanel').value;
      const loginName = document.getElementById('loginName').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!panel || !loginName || !password) {
        showMessage('loginMsg', 'Please select a panel and enter login credentials', 'error');
        return;
      }
      
      try {
        // Hide login panel
        document.getElementById('login').style.display = 'none';
        
        if (panel === 'admin') {
          // Admin login
          if (loginName === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            document.getElementById('adminPanel').style.display = "block";
            document.getElementById('admin').style.display = "block";
            
            // Show the admin menu icon
            document.getElementById('adminMenuIcon').style.display = 'block';
            
            // Initialize with animations
            setTimeout(() => {
              document.querySelectorAll('#adminPanel .section').forEach((section, index) => {
                setTimeout(() => {
                  section.classList.add('animate__fadeInUp');
                }, index * 100);
              });
            }, 100);
            
            await refreshDashboard();
            showSection('dashboard');
          } else {
            showMessage('loginMsg', 'Invalid admin credentials', 'error');
            document.getElementById('login').style.display = 'block';
          }
        } else if (panel === 'client') {
          // Client login using Supabase
          const client = await DatabaseManager.getClient(loginName, password);
          
          if (!client) {
            showMessage('loginMsg', 'Invalid credentials', 'error');
            document.getElementById('login').style.display = 'block';
            return;
          }
          
          currentUser = client.username;
          currentUserType = panel;
          currentUserId = client.id;
          
          // Update last login
          await DatabaseManager.updateLastLogin(client.id);
          
          // Show the client panel
          document.getElementById('clientPanel').style.display = "block";
          document.getElementById('client').style.display = "block";
          
          // Initialize with animations
          setTimeout(() => {
            document.querySelectorAll('#clientPanel .client-section').forEach((section, index) => {
              setTimeout(() => {
                section.classList.add('animate__fadeInUp');
              }, index * 100);
            });
          }, 100);
          
          // Load client-specific data
          await renderClientCoins();
          renderClientGames();
          showToast("Login successful!");
          
          // Apply client styling to body
          document.body.classList.add('client-body');
        } else {
          // Other panel logins (Super Master, Master, Agent) using Supabase
          let user = null;
          
          if (panel === 'superMaster') {
            user = await DatabaseManager.getSupermaster(loginName, password);
          } else if (panel === 'master') {
            user = await DatabaseManager.getMaster(loginName, password);
          } else if (panel === 'agent') {
            user = await DatabaseManager.getAgent(loginName, password);
          }
          
          if (!user) {
            showMessage('loginMsg', 'Invalid credentials', 'error');
            document.getElementById('login').style.display = 'block';
            return;
          }
          
          currentUser = user.username;
          currentUserType = panel;
          currentUserId = user.id;
          
          // Show the appropriate panel
          document.getElementById(panel + 'Panel').style.display = "block";
          document.getElementById(panel).style.display = "block";
          
          // Initialize with animations
          setTimeout(() => {
            document.querySelectorAll('#' + panel + 'Panel .section').forEach((section, index) => {
              setTimeout(() => {
                section.classList.add('animate__fadeInUp');
              }, index * 100);
            });
          }, 100);
          
          // Load panel-specific data
          if (panel === 'superMaster') {
            await renderSuperMasterInfo();
            await renderMasters();
          } else if (panel === 'master') {
            await renderMasterInfo();
            await renderAgents();
          } else if (panel === 'agent') {
            await renderAgentInfo();
            await renderClients();
          }
        }
        
        // Show announcement banner if exists
        const announcement = getStore('announcement', '');
        if (announcement) {
          document.getElementById('announcementBanner').style.display = 'block';
          document.getElementById('announcementBanner').textContent = announcement;
        }
      } catch (error) {
        console.error('Login error:', error);
        showMessage('loginMsg', 'Login failed. Please try again.', 'error');
        document.getElementById('login').style.display = 'block';
      }
    }

    async function refreshDashboard() {
      try {
        const stats = await DatabaseManager.getDashboardStats();
        document.getElementById('totalSuperMasters').textContent = stats.superMasters;
        document.getElementById('totalMasters').textContent = stats.masters;
        document.getElementById('totalAgents').textContent = stats.agents;
        document.getElementById('totalClients').textContent = stats.clients;
      } catch (error) {
        console.error('Error refreshing dashboard:', error);
        // Fallback to localStorage if Supabase fails
        const superMasters = getStore("superMasters", []).filter(u => !u.blocked);
        const masters = getStore("masters", []).filter(u => !u.blocked);
        const agents = getStore("agents", []).filter(u => !u.blocked);
        const clients = getStore("clients", []).filter(u => !u.blocked);
        
        document.getElementById('totalSuperMasters').textContent = superMasters.length;
        document.getElementById('totalMasters').textContent = masters.length;
        document.getElementById('totalAgents').textContent = agents.length;
        document.getElementById('totalClients').textContent = clients.length;
      }
    }

    async function showUserList(userType) {
      const modalTitle = document.getElementById('userListModalTitle');
      const modalContent = document.getElementById('userListModalContent');
      
      let users = [];
      let title = '';
      let tableName = '';
      
      try {
        switch(userType) {
          case 'superMasters':
            tableName = 'supermasters';
            title = 'Super Masters';
            break;
          case 'masters':
            tableName = 'masters';
            title = 'Masters';
            break;
          case 'agents':
            tableName = 'agents';
            title = 'Agents';
            break;
          case 'clients':
            tableName = 'clients';
            title = 'Clients';
            break;
        }
        
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .eq('blocked', false)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        users = data || [];
        
        modalTitle.textContent = `${title} List (${users.length})`;
        
        let userListHTML = '';
        users.forEach(user => {
          userListHTML += `
            <div class="list-item">
              <div class="list-item-header">
                <div class="list-item-title">
                  <span class="user-type-indicator ${getUserTypeIndicator(userType)}">${getUserTypeAbbr(userType)}</span>
                  ${user.username}
                </div>
              </div>
              <div class="list-item-details">
                <div class="list-item-detail"><i class="fas fa-key"></i> Login: ${user.login_name}</div>
                ${user.win_commission ? `<div class="list-item-detail"><i class="fas fa-percentage"></i> Win: ${user.win_commission}% | Loss: ${user.loss_commission}%</div>` : ''}
                <div class="list-item-detail"><i class="fas fa-lock"></i> Password: ${user.password}</div>
                <div class="list-item-detail"><i class="fas fa-money-bill-wave"></i> Balance: ₹${user.balance || 0}</div>
              </div>
            </div>
          `;
        });
        
        modalContent.innerHTML = userListHTML || '<div class="list-item">No users found</div>';
        document.getElementById('userListModal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading users:', error);
        modalContent.innerHTML = '<div class="list-item">Error loading users</div>';
        document.getElementById('userListModal').style.display = 'flex';
      }
    }

    function closeUserListModal() {
      document.getElementById('userListModal').style.display = 'none';
    }

    function renderLedger() {
      const date = document.getElementById('ledgerDate').value;
      const ledger = getStore("ledger", []);
      
      let filteredLedger = ledger;
      
      if (date) {
        filteredLedger = filteredLedger.filter(entry => entry.date === date);
      }
      
      // Calculate totals
      let totalLena = 0;
      let totalDena = 0;
      
      filteredLedger.forEach(entry => {
        if (entry.type === 'deposit') {
          totalLena += entry.amount;
        } else if (entry.type === 'withdraw') {
          totalDena += entry.amount;
        }
      });
      
      document.getElementById('totalLena').textContent = `₹${totalLena}`;
      document.getElementById('totalDena').textContent = `₹${totalDena}`;
      
      let ledgerHTML = '';
      filteredLedger.forEach((entry, index) => {
        ledgerHTML += `
          <div class="list-item" data-index="${index}">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-${getLedgerIcon(entry.type)}"></i> ${entry.user}
                <input type="checkbox" class="ledger-checkbox" data-index="${index}">
              </div>
              <div class="badge ${entry.type === 'deposit' ? 'badge-success' : 'badge-danger'}">${entry.type === 'deposit' ? 'Lena' : 'Dena'}</div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-calendar"></i> ${entry.date}</div>
              <div class="list-item-detail"><i class="fas fa-money-bill-wave"></i> Amount: ₹${entry.amount}</div>
              <div class="list-item-detail"><i class="fas fa-user-tag"></i> Panel: ${entry.panel}</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('ledgerList').innerHTML = ledgerHTML || '<div class="list-item">No ledger entries found</div>';
    }

    function showLenaUsers() {
      const date = document.getElementById('ledgerDate').value;
      const ledger = getStore("ledger", []);
      
      let filteredLedger = ledger.filter(entry => entry.type === 'deposit');
      
      if (date) {
        filteredLedger = filteredLedger.filter(entry => entry.date === date);
      }
      
      let lenaHTML = '';
      filteredLedger.forEach((entry, index) => {
        lenaHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-plus-circle"></i> ${entry.user}
              </div>
              <div class="badge badge-success">Lena</div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-calendar"></i> ${entry.date}</div>
              <div class="list-item-detail"><i class="fas fa-money-bill-wave"></i> Amount: ₹${entry.amount}</div>
              <div class="list-item-detail"><i class="fas fa-user-tag"></i> Panel: ${entry.panel}</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('ledgerList').innerHTML = lenaHTML || '<div class="list-item">No Lena entries found</div>';
    }

    function showDenaUsers() {
      const date = document.getElementById('ledgerDate').value;
      const ledger = getStore("ledger", []);
      
      let filteredLedger = ledger.filter(entry => entry.type === 'withdraw');
      
      if (date) {
        filteredLedger = filteredLedger.filter(entry => entry.date === date);
      }
      
      let denaHTML = '';
      filteredLedger.forEach((entry, index) => {
        denaHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-minus-circle"></i> ${entry.user}
              </div>
              <div class="badge badge-danger">Dena</div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-calendar"></i> ${entry.date}</div>
              <div class="list-item-detail"><i class="fas fa-money-bill-wave"></i> Amount: ₹${entry.amount}</div>
              <div class="list-item-detail"><i class="fas fa-user-tag"></i> Panel: ${entry.panel}</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('ledgerList').innerHTML = denaHTML || '<div class="list-item">No Dena entries found</div>';
    }

    function deleteSelectedLedger() {
      const checkboxes = document.querySelectorAll('.ledger-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select at least one ledger entry to delete');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${checkboxes.length} ledger entries? This action cannot be undone.`)) {
        return;
      }
      
      const ledger = getStore("ledger", []);
      const indexesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
      
      indexesToDelete.forEach(index => {
        ledger.splice(index, 1);
      });
      
      setStore("ledger", ledger);
      renderLedger();
      showMessage('submitMsg', `${indexesToDelete.length} ledger entries deleted successfully`, 'success');
    }

    function renderDeadUsers() {
      const superMasters = getStore("superMasters", []).filter(sm => sm.blocked);
      const masters = getStore("masters", []).filter(m => m.blocked);
      const agents = getStore("agents", []).filter(a => a.blocked);
      const clients = getStore("clients", []).filter(c => c.blocked);
      
      const deadUsers = [...superMasters, ...masters, ...agents, ...clients];
      
      let deadHTML = '';
      deadUsers.forEach(user => {
        const userType = getUserTypeForUser(user);
        deadHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <span class="user-type-indicator ${getUserTypeIndicator(userType)}">${getUserTypeAbbr(userType)}</span>
                ${user.user}
              </div>
              <div class="list-item-actions">
                <button class="btn btn-sm btn-success" onclick="unblockUser('${userType}', '${user.user}')">Unblock</button>
              </div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-key"></i> Login: ${user.loginName || user.user}</div>
              <div class="list-item-detail"><i class="fas fa-calendar-times"></i> Blocked by Admin</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('deadUsersList').innerHTML = deadHTML || '<div class="list-item">No dead users found</div>';
    }

    function unblockUser(type, username) {
      let users = [];
      let storeKey = '';
      
      if (type === 'superMaster') {
        storeKey = 'superMasters';
        users = getStore(storeKey, []);
      } else if (type === 'master') {
        storeKey = 'masters';
        users = getStore(storeKey, []);
      } else if (type === 'agent') {
        storeKey = 'agents';
        users = getStore(storeKey, []);
      } else if (type === 'client') {
        storeKey = 'clients';
        users = getStore(storeKey, []);
      }
      
      const userIndex = users.findIndex(u => u.user === username);
      
      if (userIndex !== -1) {
        users[userIndex].blocked = false;
        setStore(storeKey, users);
        renderDeadUsers();
        showMessage('userMsg', `User ${username} unblocked successfully`, 'success');
      }
    }

    function getUserTypeForUser(user) {
      if (getStore("superMasters", []).find(sm => sm.user === user.user)) return 'superMaster';
      if (getStore("masters", []).find(m => m.user === user.user)) return 'master';
      if (getStore("agents", []).find(a => a.user === user.user)) return 'agent';
      if (getStore("clients", []).find(c => c.user === user.user)) return 'client';
      return 'unknown';
    }

    function renderGames() {
      const blocked = getStore("blockedGames", []);
      let gamesHTML = '';
      gamesList.forEach(g => {
        gamesHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-gamepad"></i> ${g}
              </div>
              <div class="list-item-actions">
                <button class="btn btn-sm ${blocked.includes(g) ? 'btn-success' : 'btn-danger'}" 
                  onclick="toggleGame('${g}')">${blocked.includes(g) ? "Unblock" : "Block"}</button>
              </div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-info-circle"></i> Status: 
                <span class="badge ${blocked.includes(g) ? 'badge-danger' : 'badge-success'}">${blocked.includes(g) ? "Blocked" : "Active"}</span>
              </div>
            </div>
          </div>
        `;
      });
      document.getElementById('gamesListContainer').innerHTML = gamesHTML;
    }

    function toggleGame(game) {
      let blocked = getStore("blockedGames", []);
      if (blocked.includes(game)) {
        blocked = blocked.filter(g => g !== game);
        showMessage('transMsg', `${game} game unblocked`, 'success');
      } else {
        blocked.push(game);
        showMessage('transMsg', `${game} game blocked`, 'success');
      }
      setStore("blockedGames", blocked); 
      renderGames();
    }

    function populateSubmitUsers() {
      const panel = document.getElementById('submitPanel').value;
      const userSelect = document.getElementById('submitUser');
      userSelect.innerHTML = '<option value="">Select User</option>';
      
      if (!panel) return;
      
      let users = [];
      if (panel === 'superMaster') {
        users = getStore("superMasters", []).filter(u => !u.blocked);
      } else if (panel === 'master') {
        users = getStore("masters", []).filter(u => !u.blocked);
      } else if (panel === 'agent') {
        users = getStore("agents", []).filter(u => !u.blocked);
      }
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user;
        option.textContent = user.user;
        userSelect.appendChild(option);
      });
    }

    function submitTransaction() {
      const panel = document.getElementById('submitPanel').value;
      const user = document.getElementById('submitUser').value;
      const amount = parseFloat(document.getElementById('submitAmount').value);
      const type = document.getElementById('submitType').value;
      const date = document.getElementById('submitDate').value;
      
      if (!panel || !user || !amount || amount <= 0 || !date) {
        showMessage('submitMsg', 'Please fill all fields correctly', 'error');
        return;
      }
      
      // Add to submitted data
      const submittedData = getStore("submittedData", []);
      submittedData.push({
        user: user,
        type: type,
        amount: amount,
        date: date,
        panel: panel
      });
      
      // Also add to ledger
      const ledger = getStore("ledger", []);
      ledger.push({
        user: user,
        type: type,
        amount: amount,
        date: date,
        panel: panel
      });
      
      setStore("submittedData", submittedData);
      setStore("ledger", ledger);
      
      showMessage('submitMsg', `Transaction submitted successfully`, 'success');
      document.getElementById('submitAmount').value = '';
    }

    function renderSubmittedData() {
      const date = document.getElementById('dataDate').value;
      const submittedData = getStore("submittedData", []);
      
      let filteredData = submittedData;
      
      if (date) {
        filteredData = filteredData.filter(entry => entry.date === date);
      }
      
      let dataHTML = '';
      filteredData.forEach((entry, index) => {
        dataHTML += `
          <div class="list-item" data-index="${index}">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-${getLedgerIcon(entry.type)}"></i> ${entry.user}
                <input type="checkbox" class="data-checkbox" data-index="${index}">
              </div>
              <div class="badge ${entry.type === 'deposit' ? 'badge-success' : 'badge-danger'}">${entry.type === 'deposit' ? 'Lena' : 'Dena'}</div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-calendar"></i> ${entry.date}</div>
              <div class="list-item-detail"><i class="fas fa-money-bill-wave"></i> Amount: ₹${entry.amount}</div>
              <div class="list-item-detail"><i class="fas fa-user-tag"></i> Panel: ${entry.panel}</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('submittedDataList').innerHTML = dataHTML || '<div class="list-item">No submitted data found</div>';
    }

    function deleteSelectedData() {
      const checkboxes = document.querySelectorAll('.data-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('Please select at least one data entry to delete');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${checkboxes.length} data entries? This action cannot be undone.`)) {
        return;
      }
      
      const submittedData = getStore("submittedData", []);
      const indexesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
      
      indexesToDelete.forEach(index => {
        submittedData.splice(index, 1);
      });
      
      setStore("submittedData", submittedData);
      renderSubmittedData();
      showMessage('submitMsg', `${indexesToDelete.length} data entries deleted successfully`, 'success');
    }

    function renderAllUsers() {
      const panel = document.getElementById('usersPanel').value;
      const balances = getStore("balances", {});
      
      let users = [];
      let storeKey = '';
      
      if (panel === 'superMaster') {
        storeKey = 'superMasters';
        users = getStore(storeKey, []).filter(u => !u.blocked);
      } else if (panel === 'master') {
        storeKey = 'masters';
        users = getStore(storeKey, []).filter(u => !u.blocked);
      } else if (panel === 'agent') {
        storeKey = 'agents';
        users = getStore(storeKey, []).filter(u => !u.blocked);
      } else if (panel === 'client') {
        storeKey = 'clients';
        users = getStore(storeKey, []).filter(u => !u.blocked);
      }
      
      let usersHTML = '';
      users.forEach(user => {
        // Always show passwords for admin
        const showPassword = currentUserType === 'admin';
        
        usersHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <span class="user-type-indicator ${getUserTypeIndicator(panel)}">${getUserTypeAbbr(panel)}</span>
                ${user.user}
              </div>
              <div class="list-item-actions">
                <button class="btn btn-sm btn-warning" onclick="toggleUserBlock('${storeKey}', '${user.user}')">Block</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('${storeKey}', '${user.user}')">Delete</button>
              </div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-key"></i> Login: ${user.loginName || user.user}</div>
              ${showPassword ? `<div class="list-item-detail"><i class="fas fa-lock"></i> Password: ${user.pass}</div>` : ''}
              <div class="list-item-detail"><i class="fas fa-money-bill-wave"></i> Balance: ₹${balances[user.user] || 0}</div>
              ${user.winCommission ? `<div class="list-item-detail"><i class="fas fa-percentage"></i> Win: ${user.winCommission}% | Loss: ${user.lossCommission}%</div>` : ''}
            </div>
          </div>
        `;
      });
      
      document.getElementById('allUsersList').innerHTML = usersHTML || '<div class="list-item">No users found</div>';
    }

    function toggleUserBlock(type, username) {
      let users = getStore(type, []);
      const userIndex = users.findIndex(u => u.user === username);
      
      if (userIndex !== -1) {
        users[userIndex].blocked = !users[userIndex].blocked;
        setStore(type, users);
        renderAllUsers();
        showMessage('userMsg', `User ${username} ${users[userIndex].blocked ? 'blocked' : 'unblocked'}`, 'success');
      }
    }

    function deleteUser(type, username) {
      if (!confirm(`Are you sure you want to permanently delete user ${username}? This action cannot be undone!`)) {
        return;
      }
      
      let users = getStore(type, []);
      const userIndex = users.findIndex(u => u.user === username);
      
      if (userIndex !== -1) {
        users.splice(userIndex, 1);
        setStore(type, users);
        
        // Also remove from balances
        let balances = getStore("balances", {});
        delete balances[username];
        setStore("balances", balances);
        
        renderAllUsers();
        showMessage('userMsg', `User ${username} deleted permanently`, 'success');
      }
    }

    function getUserTypeIndicator(panel) {
      switch(panel) {
        case 'superMaster': return 'super-master-indicator';
        case 'master': return 'master-indicator';
        case 'agent': return 'agent-indicator';
        case 'client': return 'client-indicator';
        default: return 'admin-indicator';
      }
    }

    function getUserTypeAbbr(panel) {
      switch(panel) {
        case 'superMaster': return 'SM';
        case 'master': return 'M';
        case 'agent': return 'A';
        case 'client': return 'C';
        default: return 'A';
      }
    }

    async function createUser() {
      const userType = document.getElementById('userType').value;
      const username = document.getElementById('newUser').value.trim();
      const loginName = document.getElementById('newLoginName').value.trim();
      const password = document.getElementById('newPass').value;
      const winCommission = parseFloat(document.getElementById('winCommission').value);
      const lossCommission = parseFloat(document.getElementById('lossCommission').value);
      
      if (!username || !password || !loginName) {
        showMessage('userMsg', 'Please enter username, login name and password', 'error');
        return;
      }
      
      if (isNaN(winCommission) || isNaN(lossCommission) || winCommission < 0 || lossCommission < 0) {
        showMessage('userMsg', 'Please enter valid commission rates', 'error');
        return;
      }
      
      try {
        let newUser = null;
        
        if (userType === 'superMaster') {
          newUser = await DatabaseManager.createSupermaster(username, loginName, password, winCommission, lossCommission);
        } else if (userType === 'master') {
          // For masters, we need a supermaster ID - for now, we'll use null or handle this in UI
          showMessage('userMsg', 'Master creation requires supermaster assignment', 'error');
          return;
        } else if (userType === 'agent') {
          // For agents, we need a master ID - for now, we'll use null or handle this in UI
          showMessage('userMsg', 'Agent creation requires master assignment', 'error');
          return;
        }
        
        if (newUser) {
          showMessage('userMsg', `${userType} user "${username}" created successfully`, 'success');
          
          // Clear the form
          document.getElementById('newUser').value = '';
          document.getElementById('newLoginName').value = '';
          document.getElementById('newPass').value = '';
          document.getElementById('winCommission').value = '';
          document.getElementById('lossCommission').value = '';
          
          // Update dashboard
          await refreshDashboard();
        }
      } catch (error) {
        console.error('Error creating user:', error);
        if (error.message.includes('duplicate key')) {
          showMessage('userMsg', 'Username or login name already exists', 'error');
        } else {
          showMessage('userMsg', 'Failed to create user. Please try again.', 'error');
        }
      }
    }

    function populateCommissionUsers() {
      const panel = document.getElementById('commissionPanel').value;
      const userSelect = document.getElementById('selectUserForCommission');
      userSelect.innerHTML = '<option value="">Select User</option>';
      
      if (!panel) return;
      
      let users = [];
      if (panel === 'superMaster') {
        users = getStore("superMasters", []).filter(u => !u.blocked);
      } else if (panel === 'master') {
        users = getStore("masters", []).filter(u => !u.blocked);
      } else if (panel === 'agent') {
        users = getStore("agents", []).filter(u => !u.blocked);
      }
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user;
        option.textContent = `${user.user} (Win: ${user.winCommission || 0}%, Loss: ${user.lossCommission || 0}%)`;
        userSelect.appendChild(option);
      });
    }

    function updateUserCommission() {
      const panel = document.getElementById('commissionPanel').value;
      const username = document.getElementById('selectUserForCommission').value;
      const newWinRate = parseFloat(document.getElementById('newWinCommission').value);
      const newLossRate = parseFloat(document.getElementById('newLossCommission').value);
      
      if (!panel || !username || isNaN(newWinRate) || newWinRate < 0 || newWinRate > 100 || 
          isNaN(newLossRate) || newLossRate < 0 || newLossRate > 100) {
        showMessage('userMsg', 'Please select a panel and user and enter valid commission rates (0-100)', 'error');
        return;
      }
      
      let users = [];
      let storeKey = '';
      
      if (panel === 'superMaster') {
        storeKey = 'superMasters';
        users = getStore(storeKey, []);
      } else if (panel === 'master') {
        storeKey = 'masters';
        users = getStore(storeKey, []);
      } else if (panel === 'agent') {
        storeKey = 'agents';
        users = getStore(storeKey, []);
      }
      
      const userIndex = users.findIndex(u => u.user === username);
      
      if (userIndex === -1) return;
      
      users[userIndex].winCommission = newWinRate;
      users[userIndex].lossCommission = newLossRate;
      setStore(storeKey, users);
      
      populateCommissionUsers();
      document.getElementById('newWinCommission').value = "";
      document.getElementById('newLossCommission').value = "";
      showMessage('userMsg', 'Commission rates updated successfully', 'success');
    }

    function transact(type) {
      const panel = document.getElementById('transactionPanel').value;
      const username = document.getElementById('transUser').value.trim();
      const amount = parseFloat(document.getElementById('transAmt').value);
      
      if (!panel || !username || amount <= 0) {
        showMessage('transMsg', 'Invalid input', 'error');
        return;
      }
      
      let balances = getStore("balances", {});
      if (type === "deposit") {
        balances[username] = (balances[username] || 0) + amount;
      } else {
        if ((balances[username] || 0) < amount) {
          showMessage('transMsg', 'Insufficient balance', 'error');
          return;
        }
        balances[username] = (balances[username] || 0) - amount;
      }
      
      // Add to ledger
      const ledger = getStore("ledger", []);
      const today = new Date().toISOString().split('T')[0];
      ledger.push({
        user: username,
        type: type,
        amount: amount,
        date: today,
        panel: panel
      });
      
      setStore("balances", balances);
      setStore("ledger", ledger);
      
      showMessage('transMsg', `${type === 'deposit' ? 'Deposited' : 'Withdrew'} ₹${amount} for ${username}`, 'success');
      document.getElementById('transUser').value = "";
      document.getElementById('transAmt').value = "";
    }

    // Helper function to get ledger icon based on type
    function getLedgerIcon(type) {
      switch(type) {
        case 'deposit': return 'plus-circle';
        case 'withdraw': return 'minus-circle';
        default: return 'file-invoice-dollar';
      }
    }

    // Khata Book functions
    function populateKhataUsers() {
      const panel = document.getElementById('khataPanel').value;
      const userSelect = document.getElementById('khataUser');
      userSelect.innerHTML = '<option value="">Select User</option>';
      
      if (!panel) return;
      
      let users = [];
      if (panel === 'superMaster') {
        users = getStore("superMasters", []).filter(u => !u.blocked);
      } else if (panel === 'master') {
        users = getStore("masters", []).filter(u => !u.blocked);
      } else if (panel === 'agent') {
        users = getStore("agents", []).filter(u => !u.blocked);
      }
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.user;
        option.textContent = user.user;
        userSelect.appendChild(option);
      });
    }

    function addKhataNote() {
      const panel = document.getElementById('khataPanel').value;
      const user = document.getElementById('khataUser').value;
      const note = document.getElementById('khataNote').value.trim();
      
      if (!panel || !user || !note) {
        showMessage('khataMsg', 'Please select panel, user and enter a note', 'error');
        return;
      }
      
      const khataBook = getStore("khataBook", []);
      const today = new Date().toISOString().split('T')[0];
      
      khataBook.push({
        panel: panel,
        user: user,
        note: note,
        date: today,
        createdBy: currentUser
      });
      
      setStore("khataBook", khataBook);
      showMessage('khataMsg', 'Note added successfully', 'success');
      document.getElementById('khataNote').value = '';
      renderKhataBook();
    }

    function renderKhataBook() {
      const khataBook = getStore("khataBook", []);
      let khataHTML = '';
      
      khataBook.forEach((entry, index) => {
        khataHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-sticky-note"></i> ${entry.user} (${entry.panel})
              </div>
              <div class="badge badge-info">${entry.date}</div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail">${entry.note}</div>
              <div class="list-item-detail"><i class="fas fa-user"></i> Added by: ${entry.createdBy}</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('khataList').innerHTML = khataHTML || '<div class="list-item">No notes found</div>';
    }

    function viewKhataBook() {
      const khataBook = getStore("khataBook", []);
      const userKhata = khataBook.filter(entry => entry.user === currentUser);
      let khataHTML = '';
      
      userKhata.forEach((entry, index) => {
        khataHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <i class="fas fa-sticky-note"></i> Note from Admin
              </div>
              <div class="badge badge-info">${entry.date}</div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail">${entry.note}</div>
            </div>
          </div>
        `;
      });
      
      const modalContent = document.getElementById('khataBookModalContent');
      modalContent.innerHTML = khataHTML || '<div class="list-item">No notes found</div>';
      document.getElementById('khataBookModal').style.display = 'flex';
    }

    function closeKhataBookModal() {
      document.getElementById('khataBookModal').style.display = 'none';
    }

    // Announcement functions
    function updateAnnouncement() {
      const announcement = document.getElementById('announcementText').value.trim();
      
      if (!announcement) {
        showMessage('headingMsg', 'Please enter an announcement', 'error');
        return;
      }
      
      setStore('announcement', announcement);
      showMessage('headingMsg', 'Announcement updated successfully', 'success');
      
      // Update banner if visible
      document.getElementById('announcementBanner').style.display = 'block';
      document.getElementById('announcementBanner').textContent = announcement;
    }

    // Super Master functions
    function renderSuperMasterInfo() {
      const superMasters = getStore("superMasters", []);
      const masters = getStore("masters", []).filter(m => !m.blocked);
      const agents = getStore("agents", []).filter(a => !a.blocked);
      const clients = getStore("clients", []).filter(c => !c.blocked);
      const balances = getStore("balances", {});
      
      const superMaster = superMasters.find(sm => sm.user === currentUser);
      if (!superMaster) return;
      
      const superMasterMasters = masters.filter(m => m.superMaster === currentUser);
      const superMasterAgents = agents.filter(a => {
        const agentMaster = masters.find(m => m.user === a.master);
        return agentMaster && agentMaster.superMaster === currentUser;
      });
      const superMasterClients = clients.filter(c => {
        const clientAgent = agents.find(a => a.user === c.agent);
        if (!clientAgent) return false;
        const agentMaster = masters.find(m => m.user === clientAgent.master);
        return agentMaster && agentMaster.superMaster === currentUser;
      });
      
      document.getElementById('smTotalMasters').textContent = superMasterMasters.length;
      document.getElementById('smTotalAgents').textContent = superMasterAgents.length;
      document.getElementById('smTotalClients').textContent = superMasterClients.length;
      document.getElementById('smTotalBalance').textContent = `₹${balances[currentUser] || 0}`;
      document.getElementById('smWinCommission').textContent = `${superMaster.winCommission}%`;
      document.getElementById('smLossCommission').textContent = `${superMaster.lossCommission}%`;
      document.getElementById('smTotalCommission').textContent = `₹${superMaster.totalCommission || 0}`;
    }

    function renderMasters() {
      const masters = getStore("masters", []).filter(m => !m.blocked);
      const balances = getStore("balances", {});
      const superMasterMasters = masters.filter(m => m.superMaster === currentUser);
      
      let mastersHTML = '';
      superMasterMasters.forEach(master => {
        mastersHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <span class="user-type-indicator master-indicator">M</span>
                ${master.user} - ₹${balances[master.user] || 0}
              </div>
              <div class="list-item-actions">
                <button class="btn btn-sm btn-warning" onclick="toggleUserBlock('masters', '${master.user}')">Block</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('masters', '${master.user}')">Delete</button>
              </div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-key"></i> Login: ${master.loginName || master.user}</div>
              <div class="list-item-detail"><i class="fas fa-percentage"></i> Win: ${master.winCommission}% | Loss: ${master.lossCommission}%</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('mastersList').innerHTML = mastersHTML || '<div class="list-item">No masters found</div>';
    }

    function createMaster() {
      const username = document.getElementById('newMaster').value.trim();
      const loginName = document.getElementById('newMasterLoginName').value.trim();
      const password = document.getElementById('newMasterPass').value;
      const winCommission = parseFloat(document.getElementById('masterWinCommission').value);
      const lossCommission = parseFloat(document.getElementById('masterLossCommission').value);
      
      if (!username || !password || !loginName) {
        showMessage('masterMsg', 'Please enter username, login name and password', 'error');
        return;
      }
      
      if (isNaN(winCommission) || isNaN(lossCommission) || winCommission < 0 || lossCommission < 0) {
        showMessage('masterMsg', 'Please enter valid commission rates', 'error');
        return;
      }
      
      let masters = getStore("masters", []);
      if (masters.find(m => m.user === username)) {
        showMessage('masterMsg', 'Master already exists', 'error');
        return;
      }
      
      if (masters.find(m => m.loginName === loginName)) {
        showMessage('masterMsg', 'Login name already exists', 'error');
        return;
      }
      
      masters.push({ 
        user: username, 
        loginName: loginName,
        pass: password, 
        winCommission,
        lossCommission,
        superMaster: currentUser,
        blocked: false,
        totalCommission: 0,
        withdrawnCommission: 0,
        totalDeposits: 0,
        clientCount: 0,
        totalLoss: 0
      });
      
      setStore("masters", masters);
      showMessage('masterMsg', `Master user "${username}" created successfully`, 'success');
      
      // Clear the form
      document.getElementById('newMaster').value = '';
      document.getElementById('newMasterLoginName').value = '';
      document.getElementById('newMasterPass').value = '';
      document.getElementById('masterWinCommission').value = '';
      document.getElementById('masterLossCommission').value = '';
      
      // Update the masters list
      renderMasters();
      renderSuperMasterInfo();
    }

    // Master functions
    function renderMasterInfo() {
      const masters = getStore("masters", []);
      const agents = getStore("agents", []).filter(a => !a.blocked);
      const clients = getStore("clients", []).filter(c => !c.blocked);
      const balances = getStore("balances", {});
      
      const master = masters.find(m => m.user === currentUser);
      if (!master) return;
      
      const masterAgents = agents.filter(a => a.master === currentUser);
      const masterClients = clients.filter(c => {
        const clientAgent = agents.find(a => a.user === c.agent);
        return clientAgent && clientAgent.master === currentUser;
      });
      
      document.getElementById('mTotalAgents').textContent = masterAgents.length;
      document.getElementById('mTotalClients').textContent = masterClients.length;
      document.getElementById('mTotalBalance').textContent = `₹${balances[currentUser] || 0}`;
      document.getElementById('mWinCommission').textContent = `${master.winCommission}%`;
      document.getElementById('mLossCommission').textContent = `${master.lossCommission}%`;
      document.getElementById('mTotalCommission').textContent = `₹${master.totalCommission || 0}`;
    }

    function renderAgents() {
      const agents = getStore("agents", []).filter(a => !a.blocked);
      const balances = getStore("balances", {});
      const masterAgents = agents.filter(a => a.master === currentUser);
      
      let agentsHTML = '';
      masterAgents.forEach(agent => {
        agentsHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <span class="user-type-indicator agent-indicator">A</span>
                ${agent.user} - ₹${balances[agent.user] || 0}
              </div>
              <div class="list-item-actions">
                <button class="btn btn-sm btn-warning" onclick="toggleUserBlock('agents', '${agent.user}')">Block</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('agents', '${agent.user}')">Delete</button>
              </div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-key"></i> Login: ${agent.loginName || agent.user}</div>
              <div class="list-item-detail"><i class="fas fa-percentage"></i> Win: ${agent.winCommission}% | Loss: ${agent.lossCommission}%</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('agentsList').innerHTML = agentsHTML || '<div class="list-item">No agents found</div>';
    }

    function createAgent() {
      const username = document.getElementById('newAgent').value.trim();
      const loginName = document.getElementById('newAgentLoginName').value.trim();
      const password = document.getElementById('newAgentPass').value;
      const winCommission = parseFloat(document.getElementById('agentWinCommission').value);
      const lossCommission = parseFloat(document.getElementById('agentLossCommission').value);
      
      if (!username || !password || !loginName) {
        showMessage('agentMsg', 'Please enter username, login name and password', 'error');
        return;
      }
      
      if (isNaN(winCommission) || isNaN(lossCommission) || winCommission < 0 || lossCommission < 0) {
        showMessage('agentMsg', 'Please enter valid commission rates', 'error');
        return;
      }
      
      let agents = getStore("agents", []);
      if (agents.find(a => a.user === username)) {
        showMessage('agentMsg', 'Agent already exists', 'error');
        return;
      }
      
      if (agents.find(a => a.loginName === loginName)) {
        showMessage('agentMsg', 'Login name already exists', 'error');
        return;
      }
      
      agents.push({ 
        user: username, 
        loginName: loginName,
        pass: password, 
        winCommission,
        lossCommission,
        master: currentUser,
        blocked: false,
        totalCommission: 0,
        withdrawnCommission: 0,
        totalDeposits: 0,
        clientCount: 0,
        totalLoss: 0
      });
      
      setStore("agents", agents);
      showMessage('agentMsg', `Agent user "${username}" created successfully`, 'success');
      
      // Clear the form
      document.getElementById('newAgent').value = '';
      document.getElementById('newAgentLoginName').value = '';
      document.getElementById('newAgentPass').value = '';
      document.getElementById('agentWinCommission').value = '';
      document.getElementById('agentLossCommission').value = '';
      
      // Update the agents list
      renderAgents();
      renderMasterInfo();
    }

    // Agent functions
    function renderAgentInfo() {
      const agents = getStore("agents", []);
      const clients = getStore("clients", []).filter(c => !c.blocked);
      const balances = getStore("balances", {});
      
      const agent = agents.find(a => a.user === currentUser);
      if (!agent) return;
      
      const agentClients = clients.filter(c => c.agent === currentUser);
      const activeClients = agentClients.filter(c => (balances[c.user] || 0) > 0);
      
      document.getElementById('aTotalClients').textContent = agentClients.length;
      document.getElementById('aActiveClients').textContent = activeClients.length;
      document.getElementById('aTotalBalance').textContent = `₹${balances[currentUser] || 0}`;
      document.getElementById('aWinCommission').textContent = `${agent.winCommission}%`;
      document.getElementById('aLossCommission').textContent = `${agent.lossCommission}%`;
      document.getElementById('aTotalCommission').textContent = `₹${agent.totalCommission || 0}`;
    }

    function renderClients() {
      const clients = getStore("clients", []).filter(c => !c.blocked);
      const balances = getStore("balances", {});
      const agentClients = clients.filter(c => c.agent === currentUser);
      
      let clientsHTML = '';
      agentClients.forEach(client => {
        clientsHTML += `
          <div class="list-item">
            <div class="list-item-header">
              <div class="list-item-title">
                <span class="user-type-indicator client-indicator">C</span>
                ${client.user} - ₹${balances[client.user] || 0}
              </div>
              <div class="list-item-actions">
                <button class="btn btn-sm btn-warning" onclick="toggleUserBlock('clients', '${client.user}')">Block</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('clients', '${client.user}')">Delete</button>
              </div>
            </div>
            <div class="list-item-details">
              <div class="list-item-detail"><i class="fas fa-key"></i> Login: ${client.loginName || client.user}</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('clientsList').innerHTML = clientsHTML || '<div class="list-item">No clients found</div>';
    }

    function createClient() {
      const username = document.getElementById('newClient').value.trim();
      const loginName = document.getElementById('newClientLoginName').value.trim();
      const password = document.getElementById('newClientPass').value;
      const credit = parseFloat(document.getElementById('clientCredit').value);
      
      if (!username || !password || !loginName) {
        showMessage('clientMsg', 'Please enter username, login name and password', 'error');
        return;
      }
      
      if (!credit || credit <= 0) {
        showMessage('clientMsg', 'Please enter a valid credit limit', 'error');
        return;
      }
      
      let clients = getStore("clients", []);
      let agents = getStore("agents", []);
      let balances = getStore("balances", {});
      
      if (clients.find(c => c.user === username)) {
        showMessage('clientMsg', 'Client already exists', 'error');
        return;
      }
      
      if (clients.find(c => c.loginName === loginName)) {
        showMessage('clientMsg', 'Login name already exists', 'error');
        return;
      }
      
      clients.push({ 
        user: username, 
        loginName: loginName,
        pass: password, 
        agent: currentUser,
        blocked: false
      });
      
      balances[username] = credit;
      
      const agentIndex = agents.findIndex(a => a.user === currentUser);
      if (agentIndex !== -1) {
        agents[agentIndex].clientCount = (agents[agentIndex].clientCount || 0) + 1;
        setStore("agents", agents);
      }
      
      setStore("clients", clients); 
      setStore("balances", balances);
      showMessage('clientMsg', `Client created with credit limit of ₹${credit}`, 'success');
      
      // Clear the form
      document.getElementById('newClient').value = '';
      document.getElementById('newClientLoginName').value = '';
      document.getElementById('newClientPass').value = '';
      document.getElementById('clientCredit').value = '';
      
      // Update the clients list
      renderClients();
      renderAgentInfo();
    }

    // Client Panel Functions
    async function renderClientCoins() {
      try {
        if (currentUserId) {
          const client = await DatabaseManager.getClient(currentUser, '');
          const coins = client?.balance || 0;
          document.getElementById("clientCoins").textContent = coins;

          // Update in all games
          const balanceElements = document.querySelectorAll("#balance, #minesBetAmount, #aviatorBetAmount, #dtBetAmount, #lucky7BetAmount");
          balanceElements.forEach(el => {
            if (el.id === "balance") {
              el.textContent = `Coins: ₹${coins}`;
            } else {
              el.placeholder = `Enter Bet (Max ₹${coins})`;
              el.max = coins;
            }
          });
        }
      } catch (error) {
        console.error('Error rendering client coins:', error);
        // Fallback to localStorage
        const balances = getStore("balances", {});
        const coins = balances[currentUser] || 0;
        document.getElementById("clientCoins").textContent = coins;
      }
    }

    function renderClientGames() {
      const blocked = getStore("blockedGames", []);
      const available = gamesList.filter(g => !blocked.includes(g));
      const gamesContainer = document.getElementById("clientGames");
      gamesContainer.innerHTML = "";

      available.forEach(game => {
        const gameDiv = document.createElement("div");
        gameDiv.style.marginBottom = "15px";
        gameDiv.style.display = "flex";
        gameDiv.style.alignItems = "center";
        gameDiv.style.justifyContent = "space-between";
        gameDiv.innerHTML = `
          <span>${game}</span>
          <button class="client-button" onclick="openGame('${game.replace(" & ", " ")}')" class="fade-in" style="animation-delay: ${Math.random() * 0.5}s">Play</button>
        `;
        gamesContainer.appendChild(gameDiv);
      });
    }

    function updateLastLogin() {
      const clients = getStore("clients", []);
      const clientIndex = clients.findIndex(c => c.user === currentUser);
      if (clientIndex !== -1) {
        clients[clientIndex].lastLogin = new Date().toISOString();
        setStore("clients", clients);
        document.getElementById("lastLogin").textContent = new Date().toLocaleString();
      }
    }

    function openGame(game) {
      document.getElementById("clientPanel").style.display = "none";

      switch(game) {
        case "Mines":
          document.getElementById("minesGame").style.display = "block";
          resetMinesGame();
          break;
        case "Aviator":
          document.getElementById("aviatorGame").style.display = "block";
          resetAviatorGame();
          break;
        case "Dragon Tiger":
          document.getElementById("dragonTigerGame").style.display = "block";
          resetDragonTigerGame();
          break;
        case "Lucky 7":
          document.getElementById("lucky7Game").style.display = "block";
          resetLucky7Game();
          break;
        default:
          showToast("Game coming soon!", true);
      }
    }

    function goBackToDashboard() {
      document.querySelectorAll("#minesGame, #aviatorGame, #dragonTigerGame, #lucky7Game").forEach(el => {
        el.style.display = "none";
      });
      document.getElementById("clientPanel").style.display = "block";
    }

    // Mines Game Functions
    function resetMinesGame() {
      minesOpened = [];
      minesBet = 0;
      minesPayout = 0;
      document.getElementById("minesMsg").textContent = "";
      document.getElementById("minesGrid").innerHTML = "";
      document.getElementById("minesBetAmount").value = "";
    }

    async function startMinesGame() {
      const betAmount = parseFloat(document.getElementById("minesBetAmount").value);
      if (!betAmount || betAmount <= 0) {
        showToast("Enter valid bet amount", true);
        return;
      }

      const balances = getStore("balances", {});
      if ((balances[currentUser] || 0) < betAmount) {
        showToast("Insufficient balance", true);
        return;
      }

      try {
        // Deduct bet amount
        const currentBalance = await getCurrentClientBalance();
        if (currentBalance < betAmount) {
          showToast("Insufficient balance", true);
          return;
        }
        const newBalance = currentBalance - betAmount;
        await updateClientBalanceInDB(newBalance);
        await renderClientCoins();

        minesBet = betAmount;
        minesPayout = betAmount;
        minesBombCount = parseInt(document.getElementById("bombCount").value);

        // Generate grid
        const grid = document.getElementById("minesGrid");
        grid.innerHTML = "";

        // Create 5x5 grid (25 cells)
        for (let i = 0; i < 25; i++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.index = i;
          cell.textContent = "💎";
          cell.onclick = () => openMineCell(i);
          grid.appendChild(cell);
        }

        // Place bombs randomly (44/250 win ratio ~17.6%)
        bombPositions = [];
        const totalCells = 25;
        const safeCells = Math.floor(totalCells * 0.824); // 82.4% safe cells (17.6% bombs)

        while (bombPositions.length < (totalCells - safeCells)) {
          const pos = Math.floor(Math.random() * totalCells);
          if (!bombPositions.includes(pos)) {
            bombPositions.push(pos);
          }
        }

        document.getElementById("minesMsg").textContent = `Game started! Find ${safeCells} gems to win!`;
        showToast("Mines game started! Good luck!");
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function openMineCell(index) {
      if (minesBet === 0 || minesOpened.includes(index)) return;

      minesOpened.push(index);
      const cell = document.querySelector(`.cell[data-index="${index}"]`);

      if (bombPositions.includes(index)) {
        // Bomb hit - game over
        cell.className = "cell bomb";
        cell.textContent = "💣";

        // Reveal all bombs
        bombPositions.forEach(pos => {
          const bombCell = document.querySelector(`.cell[data-index="${pos}"]`);
          if (bombCell && !minesOpened.includes(pos)) {
            bombCell.className = "cell bomb";
            bombCell.textContent = "💣";
          }
        });

        document.getElementById("minesMsg").textContent = `Game Over! You hit a bomb and lost ₹${minesBet}`;
        await recordGameResult('Mines', minesBet, 0, 'lost');
        minesBet = 0;
      } else {
        // Gem found
        cell.className = "cell opened";
        cell.textContent = "💎";

        // Calculate payout (increase by 10% for each gem found)
        minesPayout = minesBet * (1 + (minesOpened.length * 0.1));

        // Check if all gems found
        if (minesOpened.length === (25 - bombPositions.length)) {
          try {
            const currentBalance = await getCurrentClientBalance();
            const newBalance = currentBalance + minesPayout;
            await updateClientBalanceInDB(newBalance);

            await recordGameResult('Mines', minesBet, minesPayout, 'won');

            document.getElementById("minesMsg").textContent = `You won! All gems found! Payout: ₹${minesPayout.toFixed(2)}`;
            showToast(`You won ₹${minesPayout.toFixed(2)}!`, false);
            renderClientCoins();
            minesBet = 0;

            // Add coin animation
            addCoinAnimation();
          } catch (error) {
            showToast(error.message, true);
          }
        } else {
          document.getElementById("minesMsg").textContent = `Gems found: ${minesOpened.length}/${25 - bombPositions.length}. Current payout: ${(minesPayout / minesBet).toFixed(2)}x`;
        }
      }
    }

    async function cashOutMines() {
      if (minesBet === 0 || minesOpened.length === 0) {
        showToast("No active game to cash out", true);
        return;
      }

      try {
        const currentBalance = await getCurrentClientBalance();
        const newBalance = currentBalance + minesPayout;
        await updateClientBalanceInDB(newBalance);

        await recordGameResult('Mines', minesBet, minesPayout, 'cashed_out');

        document.getElementById("minesMsg").textContent = `Cashed out! You won ₹${minesPayout.toFixed(2)}`;
        showToast(`Cashed out ₹${minesPayout.toFixed(2)}!`, false);
        renderClientCoins();
        minesBet = 0;

        // Add coin animation
        addCoinAnimation();

        // Reveal all bombs
        bombPositions.forEach(pos => {
          const bombCell = document.querySelector(`.cell[data-index="${pos}"]`);
          if (bombCell && !minesOpened.includes(pos)) {
            bombCell.className = "cell bomb";
            bombCell.textContent = "💣";
          }
        });
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // Aviator Game Functions
    function resetAviatorGame() {
      clearInterval(interval);
      crashed = false;
      cashedOut = false;
      betPlaced = false;
      multiplier = 1.00;
      document.getElementById("plane").textContent = "🛫";
      document.getElementById("plane").className = "floating";
      document.getElementById("multiplier").textContent = "Multiplier: x1.00";
      document.getElementById("result").textContent = "";
      document.getElementById("cashBtn").disabled = true;
      document.getElementById("aviatorBetAmount").value = "";
      document.getElementById("plane").style.transform = "translateY(0)";
    }

    async function placeBet() {
      if (betPlaced) return;

      const betAmount = parseFloat(document.getElementById("aviatorBetAmount").value);
      if (!betAmount || betAmount < 10 || betAmount > 5000) {
        document.getElementById("result").textContent = "Bet must be between ₹10–₹5000";
        return;
      }

      const currentBalance = await getCurrentClientBalance();
      if (currentBalance < betAmount) {
        document.getElementById("result").textContent = "Insufficient balance";
        return;
      }

      // Deduct bet amount
      const newBalance = currentBalance - betAmount;
      await updateClientBalanceInDB(newBalance);
      await renderClientCoins();

      aviatorBetAmount = betAmount;
      betPlaced = true;
      document.getElementById("cashBtn").disabled = false;
      document.getElementById("result").textContent = "Bet placed! Plane is taking off...";

      // Start the game
      multiplier = 1.00;
      crashed = false;
      cashedOut = false;

      // Determine crash point (44/250 win ratio ~17.6%)
      const rand = Math.random();
      if (rand < 0.176) {
        // Win - higher multiplier (1.5x to 10x)
        currentCrashPoint = (Math.random() * 8.5 + 1.5).toFixed(2);
      } else {
        // Lose - lower multiplier (1.0x to 1.49x)
        currentCrashPoint = (Math.random() * 0.49 + 1.0).toFixed(2);
      }

      // Start multiplier increase
      interval = setInterval(updateMultiplier, 100);
    }

    async function updateMultiplier() {
      if (crashed || cashedOut) return;

      multiplier += 0.01;
      document.getElementById("multiplier").textContent = `Multiplier: x${multiplier.toFixed(2)}`;
      document.getElementById("plane").style.transform = `translateY(${-multiplier * 5}px)`;

      // Check auto cash out
      const autoCashOut = parseFloat(document.getElementById("autoCashOut").value);
      if (autoCashOut > 0 && multiplier >= autoCashOut) {
        await cashOut();
        return;
      }

      // Check if crashed
      if (multiplier >= currentCrashPoint) {
        crashed = true;
        clearInterval(interval);
        document.getElementById("plane").className = "crash";
        document.getElementById("plane").textContent = "💥";
        document.getElementById("result").textContent = `Crashed at x${multiplier.toFixed(2)}! You lost ₹${aviatorBetAmount}`;
        document.getElementById("cashBtn").disabled = true;

        try {
          await recordGameResult('Aviator', aviatorBetAmount, 0, 'crashed');
        } catch (error) {
          console.error("Failed to record game result:", error);
        }

        // Add to history
        multiplierHistory.unshift(currentCrashPoint);
        if (multiplierHistory.length > 10) multiplierHistory.pop();
        updateHistoryDisplay();

        aviatorRounds++;
      }
    }

    async function cashOut() {
      if (!betPlaced || crashed || cashedOut) return;

      cashedOut = true;
      clearInterval(interval);

      const winAmount = aviatorBetAmount * multiplier;

      try {
        const currentBalance = await getCurrentClientBalance();
        const newBalance = currentBalance + winAmount;
        await updateClientBalanceInDB(newBalance);

        await recordGameResult('Aviator', aviatorBetAmount, winAmount, 'cashed_out');

        document.getElementById("result").textContent = `Cashed out at x${multiplier.toFixed(2)}! You won ₹${winAmount.toFixed(2)}`;
        document.getElementById("cashBtn").disabled = true;
        renderClientCoins();

        // Add coin animation
        addCoinAnimation();

        // Add to history
        multiplierHistory.unshift(multiplier.toFixed(2));
        if (multiplierHistory.length > 10) multiplierHistory.pop();
        updateHistoryDisplay();

        aviatorRounds++;
        aviatorWins++;
      } catch (error) {
        showToast(error.message, true);
      }
    }

    function updateHistoryDisplay() {
      const historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "";

      multiplierHistory.forEach(mult => {
        const isWin = parseFloat(mult) > 1.5;
        const span = document.createElement("span");
        span.className = "history-multiplier";
        span.textContent = `x${mult}`;
        span.style.background = isWin ? "var(--client-success)" : "var(--client-danger)";
        historyDiv.appendChild(span);
      });
    }

    // Dragon Tiger Game Functions
    function resetDragonTigerGame() {
      document.getElementById("dtBetAmount").value = "";
      document.getElementById("dtResult").textContent = "";
      document.getElementById("dragonCard").textContent = "";
      document.getElementById("dragonCard").className = "";
      document.getElementById("tigerCard").textContent = "";
      document.getElementById("tigerCard").className = "";
    }

    async function placeDtBet(betOn) {
      const betAmount = parseFloat(document.getElementById("dtBetAmount").value);
      if (!betAmount || betAmount <= 0) {
        showToast("Enter valid bet amount", true);
        return;
      }

      const currentBalance = await getCurrentClientBalance();
      if (currentBalance < betAmount) {
        showToast("Insufficient balance", true);
        return;
      }

      try {
        // Deduct bet amount
        const newBalance = currentBalance - betAmount;
        await updateClientBalanceInDB(newBalance);
        await renderClientCoins();

        // Deal cards
        const dragonCard = dealCard();
        const tigerCard = dealCard();

        document.getElementById("dragonCard").textContent = dragonCard;
        document.getElementById("tigerCard").textContent = tigerCard;

        // Set card color based on suit
        const dragonSuit = dragonCard.charAt(0);
        const tigerSuit = tigerCard.charAt(0);
        document.getElementById("dragonCard").classList.add(isRedSuit(dragonSuit) ? 'red' : 'black');
        document.getElementById("tigerCard").classList.add(isRedSuit(tigerSuit) ? 'red' : 'black');

        // Determine winner
        const dragonValue = getCardValue(dragonCard);
        const tigerValue = getCardValue(tigerCard);

        let resultText = "";
        let winAmount = 0;
        let result = '';

        if (dragonValue > tigerValue) {
          resultText = "Dragon wins!";
          if (betOn === "dragon") {
            winAmount = betAmount * 2;
            resultText += ` You win ₹${winAmount.toFixed(2)}!`;
            result = 'won';
          } else {
            result = 'lost';
          }
        } else if (tigerValue > dragonValue) {
          resultText = "Tiger wins!";
          if (betOn === "tiger") {
            winAmount = betAmount * 2;
            resultText += ` You win ₹${winAmount.toFixed(2)}!`;
            result = 'won';
          } else {
            result = 'lost';
          }
        } else {
          resultText = "It's a tie!";
          if (betOn === "tie") {
            winAmount = betAmount * 8;
            resultText += ` You win ₹${winAmount.toFixed(2)}!`;
            result = 'won';
          } else {
            result = 'lost';
          }
        }

        // Update balance if won
        if (winAmount > 0) {
          const currentBalance = await getCurrentClientBalance();
          const newBalance = currentBalance + winAmount;
          await updateClientBalanceInDB(newBalance);

          // Add coin animation
          addCoinAnimation();
        }

        await recordGameResult('Dragon Tiger', betAmount, winAmount, result);

        document.getElementById("dtResult").textContent = resultText;
        renderClientCoins();

        // Update stats
        dtRounds++;
        if (winAmount > 0) dtWins++;
      } catch (error) {
        showToast(error.message, true);
      }
    }

    function dealCard() {
      const value = cardValues[Math.floor(Math.random() * cardValues.length)];
      const suit = cardSuits[Math.floor(Math.random() * cardSuits.length)];
      return suit + value;
    }

    function isRedSuit(suit) {
      return suit === '♥' || suit === '♦';
    }

    function getCardValue(card) {
      const value = card.substring(1);
      if (value === "A") return 14;
      if (value === "K") return 13;
      if (value === "Q") return 12;
      if (value === "J") return 11;
      return parseInt(value);
    }

    // Lucky 7 Game Functions
    function resetLucky7Game() {
      document.getElementById("lucky7BetAmount").value = "";
      document.getElementById("lucky7Result").textContent = "";
      lucky7Spinning = false;

      // Reset slots to show 7s
      const slots = document.querySelectorAll(".lucky7-slot");
      slots.forEach(slot => {
        slot.textContent = "7";
        slot.classList.remove("spinning");
      });
    }

    async function playLucky7() {
      if (lucky7Spinning) return;

      const betAmount = parseFloat(document.getElementById("lucky7BetAmount").value);
      if (!betAmount || betAmount <= 0) {
        showToast("Enter valid bet amount", true);
        return;
      }

      const currentBalance = await getCurrentClientBalance();
      if (currentBalance < betAmount) {
        showToast("Insufficient balance", true);
        return;
      }

      try {
        // Deduct bet amount
        const newBalance = currentBalance - betAmount;
        await updateClientBalanceInDB(newBalance);
        await renderClientCoins();

        lucky7BetAmount = betAmount;
        lucky7Spinning = true;
        lucky7Rounds++;

        document.getElementById("lucky7Result").textContent = "Spinning...";

        // Animate the slots
        const slots = document.querySelectorAll(".lucky7-slot");
        slots.forEach(slot => slot.classList.add("spinning"));

        let spinsCompleted = 0;

        slots.forEach((slot, index) => {
          // Each slot spins for different durations
          const spinDuration = 1000 + (index * 500) + Math.random() * 500;
          const spinChanges = 10 + Math.floor(Math.random() * 10);

          let changes = 0;
          const spinInterval = setInterval(() => {
            slot.textContent = lucky7Symbols[Math.floor(Math.random() * lucky7Symbols.length)];
            changes++;

            if (changes >= spinChanges) {
              clearInterval(spinInterval);
              slot.classList.remove("spinning");
              spinsCompleted++;

              // When all slots stop spinning
              if (spinsCompleted === slots.length) {
                calculateLucky7Result();
              }
            }
          }, 100);
        });
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function calculateLucky7Result() {
      const slots = document.querySelectorAll(".lucky7-slot");
      const values = Array.from(slots).map(slot => slot.textContent);
      const sevenCount = values.filter(val => val === "7").length;

      let winAmount = 0;
      let resultText = "";
      let result = '';

      switch(sevenCount) {
        case 3:
          winAmount = lucky7BetAmount * 5;
          resultText = `Jackpot! Three 7s! Won ₹${winAmount.toFixed(2)} (5x)`;
          result = 'won';
          lucky7Wins++;
          break;
        case 2:
          winAmount = lucky7BetAmount * 3;
          resultText = `Two 7s! Won ₹${winAmount.toFixed(2)} (3x)`;
          result = 'won';
          lucky7Wins++;
          break;
        case 1:
          winAmount = lucky7BetAmount * 1.5;
          resultText = `One 7! Won ₹${winAmount.toFixed(2)} (1.5x)`;
          result = 'won';
          lucky7Wins++;
          break;
        default:
          resultText = `No 7s! Lost ₹${lucky7BetAmount}`;
          result = 'lost';
      }

      try {
        // Update balance if won
        if (winAmount > 0) {
          const currentBalance = await getCurrentClientBalance();
          const newBalance = currentBalance + winAmount;
          await updateClientBalanceInDB(newBalance);

          // Add coin animation
          addCoinAnimation();
        }

        await recordGameResult('Lucky 7', lucky7BetAmount, winAmount, result);

        document.getElementById("lucky7Result").textContent = resultText;
        renderClientCoins();
        lucky7Spinning = false;
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // Add coin animation to the game container
    function addCoinAnimation() {
      const container = document.querySelector('.client-section:not([style*="display: none"])');
      if (!container) return;

      for (let i = 0; i < 5; i++) {
        const coin = document.createElement('div');
        coin.className = 'coin-animation';
        coin.textContent = '💰';
        coin.style.left = `${Math.random() * 100}%`;
        coin.style.animationDelay = `${i * 0.2}s`;
        container.appendChild(coin);

        // Remove after animation
        setTimeout(() => {
          coin.remove();
        }, 2000);
      }
    }

    // Helper function to get current client balance from Supabase
    async function getCurrentClientBalance() {
      try {
        if (currentUserId) {
          const client = await DatabaseManager.getClient(currentUser, '');
          return client?.balance || 0;
        }
        return 0;
      } catch (error) {
        console.error('Error getting client balance:', error);
        // Fallback to localStorage
        const balances = getStore("balances", {});
        return balances[currentUser] || 0;
      }
    }

    // Helper function to update client balance in Supabase
    async function updateClientBalanceInDB(newBalance) {
      try {
        if (currentUserId) {
          await DatabaseManager.updateClientBalance(currentUserId, newBalance);
        }
      } catch (error) {
        console.error('Error updating client balance:', error);
        // Fallback to localStorage
        const balances = getStore("balances", {});
        balances[currentUser] = newBalance;
        setStore("balances", balances);
      }
    }

    // Record game result to match admin panel structure
    async function recordGameResult(game, betAmount, winAmount, result) {
      try {
        // Record transaction in Supabase
        if (currentUserId) {
          await DatabaseManager.recordTransaction(
            currentUserId, 
            'client', 
            'game_play', 
            result === 'won' ? winAmount - betAmount : -betAmount,
            `${game} - ${result} - Bet: ${betAmount}, Win: ${winAmount}`
          );
        }

        // Fallback to localStorage for game history
        const gameHistory = getStore("gameHistory", []);
        gameHistory.push({
          game,
          username: currentUser,
          betAmount,
          winAmount,
          result,
          timestamp: new Date().toISOString()
        });
        setStore("gameHistory", gameHistory);
      } catch (error) {
        console.error("Failed to record game result:", error);
      }
    }

    function logout() {
      currentUser = null;
      currentUserType = null;
      document.body.classList.remove('client-body');
      location.reload();
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async function() {
      initializeStorage();
      
      // Set default dates
      document.getElementById('ledgerDate').valueAsDate = new Date();
      document.getElementById('submitDate').valueAsDate = new Date();
      document.getElementById('dataDate').valueAsDate = new Date();
      
      // Add event listeners
      document.getElementById('submitPanel').addEventListener('change', () => SubmitDataManager.populateSubmitUsers());
      document.getElementById('commissionPanel').addEventListener('change', populateCommissionUsers);
      document.getElementById('khataPanel').addEventListener('change', () => KhataBookManager.populateKhataUsers());
      document.getElementById('khataUser').addEventListener('change', () => KhataBookManager.renderKhataBook());
      
      // Hide admin menu icon initially
      document.getElementById('adminMenuIcon').style.display = 'none';
      
      // Add ripple effect to buttons
      document.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', function(e) {
          const rect = this.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          
          const ripple = document.createElement('span');
          ripple.className = 'ripple';
          ripple.style.left = `${x}px`;
          ripple.style.top = `${y}px`;
          
          this.appendChild(ripple);
          
          setTimeout(() => {
            ripple.remove();
          }, 1000);
        });
      });

      // Initialize multiplier history with realistic values (44/250 win ratio)
      for (let i = 0; i < 10; i++) {
        const isHigh = Math.random() < 0.176; // 17.6% chance of high multiplier
        multiplierHistory.unshift(isHigh ?
          (Math.random() * 8.5 + 1.5).toFixed(2) :
          (Math.random() * 0.49 + 1.0).toFixed(2)
        );
      }
      updateHistoryDisplay();
    });

    // Game Variables
    // Mines Game Variables
    let minesOpened = [], minesBet = 0, minesPayout = 0;
    let minesBombCount = 3, bombPositions = [];

    // Aviator Game Variables
    let aviatorBetAmount = 0, multiplier = 1.00;
    let crashed = false, cashedOut = false, betPlaced = false;
    let interval, currentCrashPoint = 1.00;
    let multiplierHistory = [];
    let aviatorRounds = 0, aviatorWins = 0;

    // Dragon Tiger Variables
    const cardValues = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const cardSuits = ['♥','♦','♠','♣'];
    let dtRounds = 0, dtWins = 0;

    // Lucky 7 Game Variables
    let lucky7BetAmount = 0, lucky7Spinning = false;
    let lucky7Rounds = 0, lucky7Wins = 0;
    const lucky7Symbols = ['7', '🍒', '🍋', '🍊', '⭐', '🔔'];
  </script>
</body>
</html>